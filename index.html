<!DOCTYPE html>
<head>
<!-- ===== HARD MUTE AUDIO GATE (iOS Safari/Chrome Safe) ===== -->
<script>
(function(){
  var locked = true;
  var pending = new Set();
  var origPlay = HTMLMediaElement.prototype.play;
  var origVolume = new WeakMap();

  function hardMute(el){
    if (!origVolume.has(el)) origVolume.set(el, el.volume);
    el.muted = true;
    el.volume = 0;
  }
  function restore(el){
    var v = origVolume.get(el);
    el.muted = false;
    el.volume = (v != null ? v : 1);
  }

  function muteAllExisting(){
    document.querySelectorAll('audio,video').forEach(hardMute);
  }
  muteAllExisting();

  var mo = new MutationObserver(function(ms){
    if (!locked) return;
    ms.forEach(function(m){
      m.addedNodes && m.addedNodes.forEach(function(n){
        if (n && (n.tagName === 'AUDIO' || n.tagName === 'VIDEO')) hardMute(n);
        if (n && n.querySelectorAll) n.querySelectorAll('audio,video').forEach(hardMute);
      });
    });
  });
  mo.observe(document.documentElement, {childList:true, subtree:true});

  function gatedPlay(){
    if (!locked) return origPlay.apply(this, arguments);
    hardMute(this);
    pending.add(this);
    try { return Promise.resolve(); } catch(e) { return; }
  }
  HTMLMediaElement.prototype.play = gatedPlay;

  function onFirstGesture(){
    if (!locked) return;
    locked = false;
    pending.forEach(function(a){
      try {
        var p = origPlay.call(a);
        var stop = function(){
          try { a.pause(); a.currentTime = 0; restore(a); } catch(e){}
        };
        if (p && p.then) p.then(stop).catch(stop); else stop();
      } catch(e){}
    });
    pending.clear();
    HTMLMediaElement.prototype.play = origPlay;
    try { mo.disconnect(); } catch(e){}
    window.removeEventListener('pointerdown', onFirstGesture, true);
    window.removeEventListener('touchstart', onFirstGesture, true);
    window.removeEventListener('keydown', onFirstGesture, true);
    window.removeEventListener('mousedown', onFirstGesture, true);
  }

  window.addEventListener('pointerdown', onFirstGesture, { once:true, passive:true, capture:true });
  window.addEventListener('touchstart',  onFirstGesture, { once:true, passive:true, capture:true });
  window.addEventListener('keydown',     onFirstGesture, { once:true, capture:true });
  window.addEventListener('mousedown',   onFirstGesture, { once:true, capture:true });

  window.addEventListener('canplay', function(e){ if(locked) hardMute(e.target); }, true);
  window.addEventListener('canplaythrough', function(e){ if(locked) hardMute(e.target); }, true);
})();
</script>
<!-- ===== /HARD MUTE AUDIO GATE ===== -->

<meta charset="UTF-8" />
<title>ä¿®ç¾…ç‹ä¸¸ æ°¸é ã®ç„¦åœŸãƒ‘ã‚ºãƒ«(ãƒãƒƒãƒ3)</title>

  <!-- === Site Icon === -->
  <link rel="icon" href="favicon.png" type="image/png" />

  <!-- === Open Graph (SNS) === -->
  <meta property="og:title" content="ä¿®ç¾…ç‹ä¸¸ æ°¸é ã®ç„¦åœŸãƒ‘ã‚ºãƒ«" />
  <meta property="og:description" content="ã‚ãªãŸã®æŒ‡å…ˆãŒ ç„¦åœŸã«ã€Š è¯ ã€‹ã‚’å’²ã‹ã›ã‚‹ã€‚" />
  <!-- Replace the URL below with your published absolute URL -->
  <meta property="og:image" content="https://shuraomaru.itch.io/match3game/og.jpg" />
  <meta property="og:url" content="https://shuraomaru.itch.io/match3game" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="ä¿®ç¾…ç‹ä¸¸ãƒãƒƒãƒ3ã‚²ãƒ¼ãƒ " />

  <!-- === Twitter Card === -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="ä¿®ç¾…ç‹ä¸¸ æ°¸é ã®ç„¦åœŸãƒ‘ã‚ºãƒ«" />
  <meta name="twitter:description" content="ã‚ãªãŸã®æŒ‡å…ˆãŒ ç„¦åœŸã«ã€Š è¯ ã€‹ã‚’å’²ã‹ã›ã‚‹ã€‚" />
  <meta name="twitter:image" content="https://shuraomaru.itch.io/match3game/og.jpg" />

<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
<style>
.modal-overlay[hidden]{display:none !important;}

  :root{ --bg-0:#070707; --ink:#f5f7fb; --muted:#a3a7b3; --line:#2b2e34; }
  body{ margin:0; color:var(--ink); font-family:"Noto Sans JP",system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif;
    background: radial-gradient(1400px 680px at 50% -10%, #1b1c20 0%, #0c0c0e 55%, var(--bg-0) 100%),
               linear-gradient(180deg, #0b0b0c 0%, #09090a 100%); min-height:100dvh; text-align:center; }
  .wrap{ max-width:640px; margin:22px auto 28px; padding:16px; }
  .panel{ margin:0 auto; padding:16px 14px; border-radius:16px; background:#121316; border:1px solid var(--line);
    box-shadow:0 18px 60px rgba(0,0,0,.55), 0 1px 0 rgba(255,255,255,.06) inset; backdrop-filter:saturate(120%) blur(8px); }
  /* ã‚¿ã‚¤ãƒˆãƒ«ã‚µã‚¤ã‚ºï¼B */
  h1{ font-size:22px; letter-spacing:.03em; margin:4px 0 2px; font-weight:700; }
  .subtitle{ font-size:12.5px; color:var(--muted); margin:0 0 10px; letter-spacing:.05em; }
  .hud{ display:flex; gap:10px; justify-content:space-between; align-items:center; margin:10px 0 6px; flex-wrap:wrap; }
  .badge{ background:linear-gradient(180deg,#1c1d22,#14151a); border:1px solid var(--line); border-radius:999px; padding:8px 14px; font-weight:700; }
  .rank-progress{ font-size:12px; font-weight:400; margin-left:8px; opacity:0.8; }
canvas{ display:block; margin:18px auto; width:min(96vw, 480px); height:auto; aspect-ratio:1/1; box-sizing:border-box; background:#111; border-radius:14px; border:1px solid var(--line);
   box-shadow:0 16px 40px rgba(0,0,0,.6), 0 1px 0 rgba(255,255,255,.05) inset; touch-action:none; }
 .panel{ overflow:hidden; } /* ã¯ã¿å‡ºã—ã‚’å·¦å³å‡ç­‰ã«ã‚¯ãƒªãƒƒãƒ— */
  .row{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin:16px 0 12px; }
  .btn{ display:inline-flex; align-items:center; gap:.4em; font-weight:600; font-size:14px;
    background:linear-gradient(180deg,#202126,#14151a); color:#fff; border:1px solid var(--line);
    border-radius:999px; padding:8px 12px; cursor:pointer; user-select:none;
    /* â˜…ç™ºå…‰åŠ¹æœ */
    box-shadow:0 1px 0 rgba(255,255,255,.06) inset, 0 10px 24px rgba(0,0,0,.35), 0 0 0 rgba(127, 183, 255, 0);
    transition:transform .08s ease, box-shadow .18s ease, border-color .2s ease, background .2s ease; }
  /* â˜…ç™ºå…‰åŠ¹æœ (Hover) */
  .btn:hover, .btn.hover-glow{ 
    transform:translateY(-1px); border-color:#3c4048; 
    box-shadow:0 14px 28px rgba(0,0,0,.44), 0 0 10px rgba(127, 183, 255, 0.5); /* ãƒ›ãƒãƒ¼æ™‚ã®ç™ºå…‰ */
  }
  .btn:active{ transform:translateY(0); box-shadow:0 6px 14px rgba(0,0,0,.44) inset; }
  .btn-kanki{ background:linear-gradient(180deg,#233246,#17212c); border-color:#2b3b4f; }
  .btn-shodo{ background:linear-gradient(180deg,#3a1b1e,#1d0e10); border-color:#4b2a2f; }
  /* â˜…ç™ºå…‰åŠ¹æœ (Active) */
  .btn.active{ outline:2px solid #7fb7ff; box-shadow:0 14px 28px rgba(0,0,0,.44), 0 0 15px rgba(127, 183, 255, 0.8); }
  .btn-shuffle{ background:linear-gradient(180deg,#44224a,#2c1430); border-color:#5c3563; }
  .btn-mini{ padding:4px 8px; font-size:12px; }
  .status{ margin:6px 0 10px; font-size:12.5px; color:var(--muted); }

  /* æ–°è¦ï¼šãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®è‰² */
  .btn-reset{ 
    background:linear-gradient(180deg,#6e2222,#421515); 
    border-color:#a53939; color:#ffeded; 
    /* ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®ãƒ›ãƒãƒ¼æ™‚ã®ç™ºå…‰ã‚’èµ¤ç³»ã« */
    box-shadow:0 1px 0 rgba(255,255,255,.06) inset, 0 10px 24px rgba(0,0,0,.35), 0 0 0 rgba(255, 100, 100, 0);
  }
  .btn-reset:hover, .btn-reset.hover-glow{ 
    transform:translateY(-1px); border-color:#c84f4f; 
    box-shadow:0 14px 28px rgba(0,0,0,.44), 0 0 10px rgba(255, 100, 100, 0.5); /* èµ¤ç³»ç™ºå…‰ */
  }
  .btn-reset:active{ transform:translateY(0); box-shadow:0 6px 14px rgba(0,0,0,.44) inset; }


  /* æ“ä½œæ–¹æ³•ï¼ */
  details.help{ text-align:left; background:linear-gradient(180deg,#14151a,#111217); border:1px solid var(--line);
                border-radius:14px; padding:12px 14px; margin:14px 0; box-shadow:0 12px 32px rgba(0,0,0,.35) inset; }
  details.help summary{ cursor:pointer; font-weight:700; }
  details.help ul{ margin:8px 0 0 18px; } details.help li{ margin:4px 0; line-height:1.6; }
  small.note{ opacity:.75; display:block; margin-top:6px; }

  /* ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€šã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå›³é‘‘ç”¨ã‚’ãƒ™ãƒ¼ã‚¹ã«èª¿æ•´ï¼‰ */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 1000; }
  .modal-overlay.open { display: flex; }
  /* â˜…ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ä¸Šã«é‡ã­ã¦è¡¨ç¤ºã™ã‚‹ãŸã‚ã€å›³é‘‘ã¨æ“ä½œèª¬æ˜ã®Z-indexã‚’ä¸Šã’ã‚‹ */
  /* Z-index: 10010 (indexModal) < 10012 (charModal, howtoModal) */
  /* â˜…ä¿®æ­£: .openã‚¯ãƒ©ã‚¹ãŒãªãã¦ã‚‚z-indexã‚’é©ç”¨ã—ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ˆã‚Šå‰é¢ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ */
  #charModal { z-index: 20000; } 
  #howtoModal { z-index: 20000; }
  
  .modal-content { background:#191b1f; padding:25px; border-radius:12px; max-width:90%; max-height:80%; overflow-y:auto; position:relative; color:var(--ink); text-align:left; border:1px solid var(--line); box-shadow:0 12px 30px rgba(0,0,0,0.6); }
  
  /* ã‚¯ãƒ­ãƒ¼ã‚ºãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’çµ±ä¸€ */
  .close-btn { 
    position:absolute; top:10px; right:15px; z-index:1000; 
    display:inline-block; width:36px; height:36px;
    background:transparent url("images/closebutton.png") center/contain no-repeat;
    border:none;padding:0;margin:0;box-shadow:none;border-radius:0;
    color:transparent;text-indent:-9999px;overflow:hidden;cursor:pointer;
  }
  .close-btn:hover{filter:brightness(1.1);}

  /* å›³é‘‘å›ºæœ‰ */
  .char-modal-content { /* å›³é‘‘ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯å°‘ã—åºƒã‚ */
    max-width: 90%;
    max-height: 80%;
    width: min(92vw, 720px); 
    padding: 25px;
  }
  .char-list { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:15px;margin-top:20px; }
  .char-item { border:1px solid #333; padding:10px; border-radius:8px; background:#222; opacity:0.5; transition:opacity .3s; }
  .char-item.unlocked{ opacity:1; }
  .char-item h4 { margin:0 0 5px 0; font-size:16px; }
  .char-item p { margin:0; font:12px; color:var(--muted); }
  .char-item img { width:40px; height:40px; margin-right:10px; border-radius:4px; vertical-align:middle; }
  .char-item .title-row { display:flex; align-items:center; }

/* === å›³é‘‘ï¼šãƒ­ãƒƒã‚¯ä¸­ã¯å®Œå…¨ãƒ–ãƒ©ã‚¤ãƒ³ãƒ‰è¡¨ç¤º === */
.char-item.locked{ 
  opacity:1;
  background:#1b1b1b;
}
.char-item.locked .title-row img,
.char-item.locked .char-tag,
.char-item.locked p,
.char-item.locked small{
  display:none !important;
}
.char-item.locked .title-row::before{
  content:"";
  display:inline-block;
  width:40px; height:40px;
  margin-right:10px;
  border-radius:4px;
  background:#0e0e0e;
  border:1px solid #333;
}

  /* å›³é‘‘ã®ã‚¿ã‚° */
  .char-tag{ display:inline-block; font-size:10px; padding:3px 6px; border-radius:4px; font-weight:700; border:1px solid #444; margin-left:6px; }
  .char-tag.yellow{ background:#4d4200; border-color:#6b5e00; color:#ffd900; } /* åˆæ­“=é»„è‰² */
  .char-tag.blue  { background:#0c2a4a; border-color:#174a7a; color:#7fc8ff; }/* è¾°åéƒ=é’ */
  .char-tag.red   { background:#3a0c12; border-color:#5a1c22; color:#ff8a8a; }/* ãƒ—ãƒ­ãƒ‘ã‚¬ãƒ³ãƒ€=èµ¤ */
  .char-tag.neutral{ background:#333; color:#ccc; }
  .char-tag.orange{ background:#4a2a00; border-color:#6a3a00; color:#ffb25f; }/* ç‰¹æ®Š=æ©™ */

  /* æœ€çµ‚ãƒ©ãƒ³ã‚¯æ™‚ï¼šç‰¹æ®Šé¸æŠè¡Œã®ã‚¢ã‚¤ã‚³ãƒ³ãƒœã‚¿ãƒ³ */
  #rankSelectRow .btn-icon{
    display:inline-flex; align-items:center; gap:4px; padding:2px 4px; border-radius:10px;
    font-size:12px; line-height:0; border:1px solid var(--line); background:linear-gradient(180deg,#222,#16171b);
    cursor:pointer; user-select:none;
    /* â˜…ç™ºå…‰åŠ¹æœ */
    box-shadow:0 1px 0 rgba(255,255,255,.06) inset, 0 10px 24px rgba(0,0,0,.35), 0 0 0 rgba(127, 183, 255, 0);
    transition:transform .08s ease, box-shadow .18s ease, border-color .2s ease, background .2s ease;
  }

  #rankSelectRow .btn-icon:hover{ transform:translateY(-1px); border-color:#3c4048; box-shadow:0 14px 28px rgba(0,0,0,.44), 0 0 10px rgba(127, 183, 255, 0.5); }
  #rankSelectRow .btn-icon.active{ outline:2px solid #7fb7ff; box-shadow:0 14px 28px rgba(0,0,0,.44), 0 0 15px rgba(127, 183, 255, 0.8); }

#rankSelectRow { 
  gap: 14px;
}
  #rankSelectRow .btn-icon img{ width:40px; height:40px; border-radius:3px; display:block; }
  
.panel{ overflow: hidden; }
.panel > .row + .row { margin-top: 10px; }
.panel > .row:not(#rankSelectRow) {
  justify-content: center;
  gap: 12px;
  width: 100%;
}
details.help summary,
details.help ul,
details.help li {
  text-align: left;
}

/* === ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒœã‚¿ãƒ³ï¼‹ãƒ¢ãƒ¼ãƒ€ãƒ«  === */
/* å³ä¸Šã«å›ºå®šã™ã‚‹ãƒœã‚¿ãƒ³ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰ */
#indexBtn{
  position:fixed;top:10px;right:10px;width:40px;height:40px;
  display:inline-grid;place-items:center;border-radius:10px;border:1px solid var(--line);
  /* ã‚¢ã‚¤ã‚³ãƒ³ã¯é©å®œå¤‰æ›´ã—ã¦ãã ã•ã„ã€‚ã“ã“ã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®howtoã‚¢ã‚¤ã‚³ãƒ³ã‚’æµç”¨ */
  background:rgba(20,20,20,.9) url("images/howtobutton.png") center/28px 28px no-repeat;
  color:transparent;cursor:pointer;z-index:10005; border-color:#4169E1;
  /* â˜…ç™ºå…‰åŠ¹æœ */
  box-shadow:0 0 0 rgba(127, 183, 255, 0);
  transition: box-shadow .2s ease, border-color .2s ease, background .2s ease;
}
#indexBtn:hover{
  border-color:#7fb7ff;
  box-shadow:0 0 8px rgba(127, 183, 255, 0.6);
}

#indexModal[hidden]{display:none;}
#indexModal{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.8);z-index:10010;}
#indexModal .index-panel{
  background:#111;color:var(--ink);border:1px solid var(--line);border-radius:14px;
  width:min(92vw,360px);max-height:90vh;box-shadow:0 10px 28px rgba(0,0,0,.6);
  position:relative;padding:25px;text-align:center;
}
#indexModal .index-panel h2{margin:0 0 20px; font-size:24px;}
/* ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å†…ã®ãƒœã‚¿ãƒ³ãƒªã‚¹ãƒˆ */
#indexModal .btn-list{display:grid; gap:12px;}
#indexModal .btn-list .btn{ 
  width:100%; justify-content:center; 
  padding:12px 16px; /* ãƒœã‚¿ãƒ³ã‚’å¤§ãã */
  font-size:16px; 
}
/* BGM/SEãƒœã‚¿ãƒ³ã¯å°ã•ãå·¦å³ã«ä¸¦ã¹ã‚‹ */
#indexModal .btn-group{display:flex; gap:10px;}
#indexModal .btn-group .btn{ flex:1; padding:10px 12px; font-size:15px; }

/* è¦šé†’ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¨ãƒãƒ¼ã‚¸ãƒ³ */
#indexModal #resetRankBtn{ 
  margin-top: 30px; /* ä»–ã®ãƒœã‚¿ãƒ³ã¨é–“éš”ã‚’ç©ºã‘ã‚‹ */
  padding:12px 16px; 
  font-size:16px; 
}


/* === æ“ä½œèª¬æ˜ãƒ¢ãƒ¼ãƒ€ãƒ« (howtoModal) === */
#howtoModal[hidden]{display:none;} /* è¿½åŠ  */
#howtoModal .modal-content { 
  width:min(92vw,720px); max-height:90vh; padding:14px 14px 10px; /* å›³é‘‘ã‚ˆã‚Šè–„ã */
}
#howtoModal .howto-img-wrap{position:relative;display:grid;place-items:center;aspect-ratio:16/9;background:#000;border-radius:10px;overflow:hidden;}
#howtoModal img#howtoImg{width:100%;height:auto;object-fit:contain;user-select:none;-webkit-user-drag:none;}
#howtoModal .howto-nav{position:absolute;top:50%;transform:translateY(-50%);width:44px;height:44px;border-radius:9999px;border:1px solid var(--line);background:rgba(28,28,28,.9);color:var(--ink);cursor:pointer;z-index:10;}
#howtoModal .howto-nav.prev{left:8px;}
#howtoModal .howto-nav.next{right:8px;}
#howtoModal .howto-caption{margin-top:8px;text-align:center;font-size:13px;opacity:.9;}


/* === ãƒ©ãƒ³ã‚¯ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« (æ–°è¦) === */
#resetConfirmModal[hidden]{display:none;}
#resetConfirmModal{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.9);z-index:10015;}
#resetConfirmModal .modal-content {
  max-width: 320px;
  padding: 30px 20px 20px;
  text-align: center;
  background:#201111; /* èµ¤é»’ç³»ã®èƒŒæ™¯ */
  border-color:#4d2020;
}
#resetConfirmModal h3 {
  margin: 0 0 20px;
  font-size: 18px;
  color: #ffc0c0;
}
#resetConfirmModal .confirm-btns {
  display: flex;
  justify-content: space-around;
  margin-top: 20px;
}
#resetConfirmModal .confirm-btns .btn {
  width: 45%;
  font-size: 15px;
}
/* ã¯ã„ãƒœã‚¿ãƒ³ã¯èµ¤ç³» */
#resetConfirmModal #confirmResetYes {
    background: linear-gradient(180deg,#6e2222,#421515);
    border-color: #a53939;
    color: #ffeded;
}

/* hide debug status */
#status{ display:none !important; }
</style>
<style>
/* === BGM selection glow colors === */
.btn.bgm1-active{ outline:2px solid rgba(120,200,150,.85); box-shadow:0 0 15px rgba(120,200,150,.7); }
.btn.bgm2-active{ outline:2px solid rgba(240,120,120,.85); box-shadow:0 0 15px rgba(240,120,120,.7); }
/* FX canvas safety */
#fxCanvas{ background:transparent!important; pointer-events:none; z-index:1!important; display:none; }

/* hide debug status */
#status{ display:none !important; }
</style>

<!-- howto responsive fit override -->
<style id="howto-fit-override">
#howtoModal .modal-content{
  width: min(94vw, 640px);
  max-height: 92vh;
  overflow: hidden;
}
#howtoModal .howto-img-wrap{
  width: 100%;
  height: auto;
  max-height: 85vh;
  aspect-ratio: auto;
  display: grid;
  place-items: center;
  background: #000;
  border-radius: 10px;
  overflow: hidden;
}
#howtoModal .howto-img-wrap img,
#howtoModal img#howtoImg{
  max-width: 100%;
  max-height: 85vh;
  width: auto;
  height: auto;
  object-fit: contain;
  user-select: none;
  -webkit-user-drag: none;
  display: block;
}
</style>

<!-- howto nav shift override: move prev/next half outside so they don't cover the image -->
<style id="howto-nav-shift-override">
/* ç”»åƒå¤–å´ã«ãƒœã‚¿ãƒ³ã‚’ãšã‚‰ã™ãŸã‚ã€ãƒ©ãƒƒãƒ‘ãƒ¼ã®ã¯ã¿å‡ºã—ã‚’è¨±å¯ */
#howtoModal .howto-img-wrap{
  overflow: visible !important;
  position: relative;
}

/* ã‚ˆãã‚ã‚‹ã‚»ãƒ¬ã‚¯ã‚¿ç¾¤ã«ã¾ã¨ã‚ã¦é©ç”¨ï¼ˆã©ã‚Œã‹ã«ãƒãƒƒãƒã™ã‚Œã°å‹•ãï¼‰ */
#howtoModal .howto-prev, 
#howtoModal .howto-next,
#howtoModal .howto-nav .prev, 
#howtoModal .howto-nav .next,
#howtoModal #howtoPrev, 
#howtoModal #howtoNext,
#howtoModal .btn-prev,
#howtoModal .btn-next{
  position: absolute !important;
  top: 50% !important;
  transform: translateY(-50%) !important;
  z-index: 5;
}

/* å·¦ãƒœã‚¿ãƒ³ï¼šè‡ªåˆ†ã®ç›´å¾„ã¶ã‚“å¤–ã¸ï¼ˆ= è¿½åŠ ã§åŠåˆ†å¤–å´ã«ï¼‰ */
#howtoModal .howto-prev,
#howtoModal .howto-nav .prev,
#howtoModal #howtoPrev,
#howtoModal .btn-prev{
  left: 0 !important;
  transform: translate(calc(-27.5% - 8px), -50%) !important; 
}

/* å³ãƒœã‚¿ãƒ³ï¼šè‡ªåˆ†ã®ç›´å¾„ã¶ã‚“å¤–ã¸ */
#howtoModal .howto-next,
#howtoModal .howto-nav .next,
#howtoModal #howtoNext,
#howtoModal .btn-next{
  right: 0 !important;
  transform: translate(calc(27.5% + 8px), -50%) !important;
}
</style>
<!-- howto arrow color override -->
<style id="howto-arrow-color-override">
/* 1) ãƒ†ã‚­ã‚¹ãƒˆã‚„ã‚¢ã‚¤ã‚³ãƒ³ãƒ•ã‚©ãƒ³ãƒˆã§ä½œã‚‰ã‚ŒãŸçŸ¢å°ã‚’èµ¤ã« */
#howtoModal .howto-prev,
#howtoModal .howto-next,
#howtoModal .howto-nav .prev,
#howtoModal .howto-nav .next,
#howtoModal #howtoPrev,
#howtoModal #howtoNext,
#howtoModal .btn-prev,
#howtoModal .btn-next{
  color: #ff3b3b !important;  /* é®®ã‚„ã‹ãªèµ¤ */
}

/* 2) ç–‘ä¼¼è¦ç´ ã§çŸ¢å°ã‚’å‡ºã—ã¦ã„ã‚‹å ´åˆï¼ˆ::before ãªã©ï¼‰ */
#howtoModal .howto-prev::before,
#howtoModal .howto-next::before,
#howtoModal .howto-nav .prev::before,
#howtoModal .howto-nav .next::before,
#howtoModal #howtoPrev::before,
#howtoModal #howtoNext::before,
#howtoModal .btn-prev::before,
#howtoModal .btn-next::before{
  color: #ff3b3b !important;
}

/* 3) SVGã‚¢ã‚¤ã‚³ãƒ³ã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆ */
#howtoModal .howto-prev svg,
#howtoModal .howto-next svg,
#howtoModal .howto-nav .prev svg,
#howtoModal .howto-nav .next svg,
#howtoModal #howtoPrev svg,
#howtoModal #howtoNext svg,
#howtoModal .btn-prev svg,
#howtoModal .btn-next svg{
  fill: #ff3b3b !important;
  stroke: #ff3b3b !important; /* ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³å‹ã§ã‚‚èµ¤ã« */
}
</style>

</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="hud">
        <div class="badge" id="score">æš—èºå€¤: 0</div> <div class="badge" id="rank">ä¿®ç¾…ç‹ä¸¸: ãƒŸãƒŸãƒƒã‚¯ <span class="rank-progress" id="rankProgress"></span></div>
      </div>

      <canvas id="gameCanvas"></canvas>
      <div class="row" id="rankSelectRow" style="display:none;"></div>

      <div class="row">
        <button class="btn btn-kanki" id="btnKanki" onclick="setMode('kanki'); userGesture(); onClickSE()">æ­“å–œ</button>
        <button class="btn btn-shodo" id="btnShodo" onclick="setMode('shodo'); userGesture(); onClickSE()">ç„¦åœŸ</button>
        <button class="btn" id="pauseBtn" onclick="togglePause(); onClickSE()">â¸ ä¸€æ™‚åœæ­¢</button>
      </div>

      <div class="status" id="status">status: ready</div>



      <small class="note">â’¸ 2010 Guild Noir. ã€€ä¿®ç¾…ç‹ä¸¸Â®</small>

      <div id="charModal" class="modal-overlay" onclick="if(event.target.id === 'charModal') closeCharModal()" hidden>
        <div class="modal-content char-modal-content">
          <button class="close-btn" onclick="closeCharModal()" aria-label="é–‰ã˜ã‚‹"></button>
          <h2>ğŸ‘¤ ä¿®ç¾…ç‹ä¸¸ é¡•ç¾åé‘‘</h2>
          <div id="char-list" class="char-list"></div>
        </div>
      </div>
    </div>
  </div>

  <audio id="bgm1" src="audio/bgm1.mp3" loop preload="auto"></audio>
  <audio id="bgm2" src="audio/bgm2.mp3" loop preload="auto"></audio>
  <audio id="se_index" src="audio/se_index.mp3" preload="auto"></audio>
<audio id="se_vertical"   src="audio/se_vertical.mp3"   preload="auto"></audio>
  <audio id="se_horizontal" src="audio/se_horizontal.mp3" preload="auto"></audio>
  <audio id="se_circle"     src="audio/se_circle.mp3"     preload="auto"></audio>
  <audio id="se_cross"      src="audio/se_cross.mp3" preload="auto"></audio>
  <audio id="se_pop"        src="audio/se_pop.mp3"        preload="auto"></audio>
  <audio id="se_whoosh"     src="audio/se_whoosh.mp3" preload="auto"></audio>
  <audio id="se_shine"      src="audio/se_shine.mp3"  preload="auto"></audio>
  <audio id="se_push"       src="audio/se_push.mp3"   preload="auto"></audio>
  <audio id="se_bell"       src="audio/se_bell.mp3"    preload="auto"></audio>
  <audio id="se_rumble"     src="audio/se_rumble.mp3"  preload="auto"></audio>
  <audio id="se_not"       src="audio/se_not.mp3"  preload="auto"></audio>
  <audio id="vo_rank0" src="audio/vo_rank0.mp3" preload="auto"></audio>
  <audio id="vo_rank1" src="audio/vo_rank1.mp3" preload="auto"></audio>
  <audio id="vo_rank2" src="audio/vo_rank2.mp3" preload="auto"></audio>
  <audio id="vo_rank3" src="audio/vo_rank3.mp3" preload="auto"></audio>
  <audio id="vo_rank4" src="audio/vo_rank4.mp3" preload="auto"></audio>
  <audio id="vo_rank5" src="audio/vo_rank5.mp3" preload="auto"></audio>
  <audio id="vo_reset" src="audio/vo_reset.mp3" preload="auto"></audio>

<button id="indexBtn" title="ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹" aria-label="ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹"></button>
<div id="indexModal" role="dialog" aria-modal="true" aria-label="ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ¡ãƒ‹ãƒ¥ãƒ¼" hidden class="modal-overlay">
  <div class="index-panel">
    <button class="close-btn" onclick="closeIndexModal(); onClickSE()" aria-label="é–‰ã˜ã‚‹"></button>
    <h2>âš™ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹</h2>
    <div class="btn-list">
      <div class="btn-group">
        <button class="btn" id="bgmBtnIndex" onclick="toggleBGM(); onClickSE()">â™ª BGM ON</button>
        <button class="btn" id="seBtnIndex"  onclick="toggleSE(); onClickSE()">ğŸ”Š SE ON</button>
      </div>
      <button class="btn" id="bgmSelectBtn" onclick="toggleBGMSelect(); onClickSE()">â™ª1 / â™ª2 BGMåˆ‡æ›¿</button>
      
      <button class="btn" id="btnCharIntroIndex" onclick="openCharModal(); onClickSE()">ğŸ‘¤ ä¿®ç¾…ç‹ä¸¸ é¡•ç¾åé‘‘</button>
      
      <button class="btn" id="openHowtoBtn" onclick="openHowto(); onClickSE()">â“˜ æ“ä½œèª¬æ˜</button>
      
      <button class="btn btn-reset" id="resetRankBtn" onclick="openResetConfirmModal(); onClickSE()">
        ğŸ”¥ è¦šé†’ãƒ©ãƒ³ã‚¯ã®ãƒªã‚»ãƒƒãƒˆ
      </button>
    </div>
  </div>
</div>

<div id="resetConfirmModal" role="dialog" aria-modal="true" aria-label="è¦šé†’ãƒ©ãƒ³ã‚¯ã®ãƒªã‚»ãƒƒãƒˆç¢ºèª" hidden>
  <div class="modal-content">
    <h3>è¦šé†’ãƒ©ãƒ³ã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ</h3>
    <p>ã“ã‚Œã¾ã§ã®è¦šé†’ãƒ©ãƒ³ã‚¯ã¨æš—èºé€²æ—ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã™ã€‚</p>
    <div class="confirm-btns">
      <button class="btn" id="confirmResetNo" onclick="closeResetConfirmModal(); onClickSE()">ã„ã„ãˆ</button>
      <button class="btn btn-reset" id="confirmResetYes" onclick="resetRank(); onClickSE()">ã¯ã„</button>
    </div>
  </div>
</div>


<div id="howtoModal" role="dialog" aria-modal="true" aria-label="æ“ä½œæ–¹æ³•" hidden class="modal-overlay">
  <div class="modal-content">
    <button class="close-btn" id="howtoCloseBtn" onclick="closeHowto()" aria-label="é–‰ã˜ã‚‹"></button> <div class="howto-img-wrap">
      <button class="howto-nav prev" id="howtoPrev" aria-label="å‰ã®ç”»åƒ" onclick="prevHowtoPage()">â—€</button>
      <img id="howtoImg" alt="æ“ä½œæ–¹æ³•" />
      <button class="howto-nav next" id="howtoNext" aria-label="æ¬¡ã®ç”»åƒ" onclick="nextHowtoPage()">â–¶</button>
    </div>
    <div class="howto-caption"><span id="howtoCounter">1 / 1</span></div>
  </div>
</div>


<script>
"use strict";

/* ===== æ°¸ç¶šåŒ– ===== */
const store = { get(k,d){try{const v=localStorage.getItem(k);return v===null?d:JSON.parse(v);}catch(_){return d}}, set(k,v){try{localStorage.setItem(k,JSON.stringify(v));}catch(_){}} };

/* ===== ã‚µã‚¦ãƒ³ãƒ‰ï¼ˆBGM2ç³»çµ±ï¼‹SEãƒ—ãƒ¼ãƒ«ï¼‰ ===== */
const bgm1 = document.getElementById("bgm1");
const bgm2 = document.getElementById("bgm2");
let activeBGM = store.get("activeBGM", 1) === 2 ? bgm2 : bgm1;
let bgmOn = !!store.get("bgmOn", false);

/* â˜…ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å†…ã®BGM/SEãƒœã‚¿ãƒ³ã«å¤‰æ›´ */
const bgmBtn = document.getElementById("bgmBtnIndex"); // BGM ON/OFFãƒœã‚¿ãƒ³
const seBtn  = document.getElementById("seBtnIndex");  // SE ON/OFFãƒœã‚¿ãƒ³
const bgmSelectBtn = document.getElementById("bgmSelectBtn"); // BGMåˆ‡æ›¿ãƒœã‚¿ãƒ³

const BGM_DEFAULT_VOL = 0.35;
const SE_DEFAULT_VOL  = 0.25;

function makePool(a,n){ const arr=[a]; for(let i=1;i<n;i++) arr.push(a.cloneNode(true)); let idx=0;
  return { play(v){ const e=arr[idx++%arr.length]; try{e.pause();e.currentTime=0;}catch(_){}
    e.volume=v; e.play().catch(()=>{}); } };
}
const SE_BANK = {
  vertical:document.getElementById("se_vertical"),
  horizontal:document.getElementById("se_horizontal"),
  circle:document.getElementById("se_circle"),
  cross:document.getElementById("se_cross"),
  pop:document.getElementById("se_pop"),
  whoosh:document.getElementById("se_whoosh"),
  rumble:document.getElementById("se_rumble"),
  shine:document.getElementById("se_shine"),
  push:document.getElementById("se_push"), 
  index:document.getElementById("se_index"), /* index open */
  /* â˜…push.mp3ã‚’è¿½åŠ  */
  bell:document.getElementById("se_bell"),
ã€€not:document.getElementById("se_not"),
};
const Sound={ enabled:store.get("seOn", true), vol:store.get("seVol", SE_DEFAULT_VOL), pools:{},
  init(){ for(const k in SE_BANK){ if(SE_BANK[k]) this.pools[k]=makePool(SE_BANK[k],6); } },
  play(n, volMul=1){ if(!this.enabled) return; const p=this.pools[n]; if(p) p.play(this.vol*volMul); },
}; Sound.init();

function setBGMVol(v){ const nv=Number(v); bgm1.volume=nv; bgm2.volume=nv; store.set("bgmVol", nv); }
function setSEVol(v){ const nv=Number(v); Sound.vol=nv; store.set("seVol", nv); }

function toggleSE(){ 
  Sound.enabled=!Sound.enabled; 
  seBtn.textContent=Sound.enabled?"ğŸ”Š SE ON":"ğŸ”‡ SE OFF"; 
  store.set("seOn", Sound.enabled); 
  /* ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†…ã®ãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–/éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§è£…é£¾ */
  seBtn.classList.toggle('active', Sound.enabled);
}

function pauseAllBGM(){ try{bgm1.pause();}catch(_){} try{bgm2.pause();}catch(_){} }
function currentBGM(){ return activeBGM===bgm2?bgm2:bgm1; }

function updateBGMSelectButton(){
  const which = activeBGM === bgm2 ? 2 : 1;
  bgmSelectBtn.textContent = (which === 1) ? "â™ª1 BGMåˆ‡æ›¿" : "â™ª2 BGMåˆ‡æ›¿";
  bgmSelectBtn.classList.toggle('active', true);
  try{ bgmSelectBtn.classList.toggle('bgm1-active', which===1); bgmSelectBtn.classList.toggle('bgm2-active', which===2); }catch(e){}
}

/* â˜…BGMåˆ‡æ›¿ï¼ˆâ™ª1/â™ª2ã®åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼‰ */
function toggleBGMSelect(){
  const newWhich = activeBGM === bgm1 ? 2 : 1;
  selectBGM(newWhich);
  updateBGMSelectButton();
}

function toggleBGM(){
  if(!bgmOn){
    pauseAllBGM(); currentBGM().currentTime = 0;
    currentBGM().play().catch(()=>{});
    bgmOn = true; 
    bgmBtn.textContent="ğŸ”Š â™ª BGM ON"; // ONçŠ¶æ…‹ã®ãƒ†ã‚­ã‚¹ãƒˆ
  }else{
    pauseAllBGM(); 
    bgmOn = false; 
    bgmBtn.textContent="ğŸ”‡ â™ª BGM OFF"; // OFFçŠ¶æ…‹ã®ãƒ†ã‚­ã‚¹ãƒˆã«çµ±ä¸€
  }
  store.set("bgmOn", bgmOn);
  /* ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†…ã®ãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–/éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§è£…é£¾ */
  bgmBtn.classList.toggle('active', bgmOn);
}

function selectBGM(which){
  pauseAllBGM();
  activeBGM = (which===2)?bgm2:bgm1;
  store.set("activeBGM", which);
  setBGMVol(store.get("bgmVol", BGM_DEFAULT_VOL));
  activeBGM.currentTime = 0;

  updateBGMSelectButton(); // è¡¨ç¤ºæ›´æ–°ï¼ˆè‰²/ãƒ©ãƒ™ãƒ«ï¼‰

  if(bgmOn){ 
    currentBGM().play().then(()=>{ 
      bgmBtn.textContent="ğŸ”Š â™ª BGM ON"; // â˜…ä¿®æ­£ï¼šONçŠ¶æ…‹ã®ãƒ†ã‚­ã‚¹ãƒˆã«çµ±ä¸€
      bgmBtn.classList.add('active'); 
    }).catch(()=>{
      // è‡ªå‹•å†ç”Ÿå¤±æ•—æ™‚ã¯OFFã«æˆ»ã™
      bgmOn=false; store.set("bgmOn", false);
      pauseAllBGM(); 
      bgmBtn.textContent="ğŸ”‡ â™ª BGM OFF"; // â˜…ä¿®æ­£ï¼šOFFçŠ¶æ…‹ã®ãƒ†ã‚­ã‚¹ãƒˆã«çµ±ä¸€
      bgmBtn.classList.remove('active');
    }); 
  }
  else{ 
    pauseAllBGM(); 
    bgmBtn.textContent="ğŸ”‡ â™ª BGM OFF"; // â˜…ä¿®æ­£ï¼šOFFçŠ¶æ…‹ã®ãƒ†ã‚­ã‚¹ãƒˆã«çµ±ä¸€
    bgmBtn.classList.remove('active');
  }
}

/* åˆå›ã‚¸ã‚§ã‚¹ãƒãƒ£ã§BGM/SEè§£ç¦ */
let audioUnlocked=false;
function unlockAllSE(){
  if(audioUnlocked) return;
  audioUnlocked=true;
  for(const k in SE_BANK){
    const a=SE_BANK[k]; if(!a) continue;
    try{ const v=a.volume; a.volume=0.0001; a.play().then(()=>{ a.pause(); a.currentTime=0; a.volume=v; }).catch(()=>{ a.volume=v; }); }catch(_){}
  }
}
function userGesture(){
  unlockAllSE();
// â˜…ã‚¿ãƒƒãƒ/ç§»å‹•ã§BGMã‚’ã‚­ãƒƒã‚¯ï¼ˆåœæ­¢ä¸­ãªã‚‰å†ç”Ÿã‚’è©¦ã¿ã‚‹ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š(bgmOn)ã‚’å°Šé‡ã™ã‚‹ï¼‰
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ˜ç¤ºçš„ã«BGMã‚’OFFã«ã—ã¦ã„ã‚‹å ´åˆã¯å†ç”Ÿã‚‚çŠ¶æ…‹ã®ä¸Šæ›¸ãã‚‚ã—ãªã„ã‚ˆã†ã«ä¿®æ­£
  if (bgmOn && currentBGM().paused){ 
    currentBGM().currentTime = 0;
    currentBGM().play().catch(()=>{});
  }
}
(function initAudio(){
  setBGMVol(store.get("bgmVol", BGM_DEFAULT_VOL));
  if(!Sound.enabled) seBtn.textContent="ğŸ”‡ SE OFF";
  seBtn.classList.toggle('active', Sound.enabled);

  const which=store.get("activeBGM",1);
  activeBGM = which===2?bgm2:bgm1;
  updateBGMSelectButton(); /* BGMåˆ‡æ›¿ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºæ›´æ–° */

  if(bgmOn){ 
    currentBGM().play().then(()=>{ 
      bgmBtn.textContent="â™ª BGM OFF";
      bgmBtn.classList.add('active'); 
    }).catch(()=>{
      // è‡ªå‹•å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§1å›ã ã‘å¾©å¸°ï¼ˆONè¨­å®šæ™‚ã®ã¿ï¼‰
      const resumeOnce = ()=>{
        if(!bgmOn) return;
        try{ pauseAllBGM(); currentBGM().currentTime=0; currentBGM().play().catch(()=>{}); }catch(_){}
        document.removeEventListener('pointerdown', resumeOnce, true);
        document.removeEventListener('keydown', resumeOnce, true);
        document.removeEventListener('touchstart', resumeOnce, true);
        bgmBtn.textContent="â™ª BGM OFF";
        bgmBtn.classList.add('active');
      };
      document.addEventListener('pointerdown', resumeOnce, true);
      document.addEventListener('keydown', resumeOnce, true);
      document.addEventListener('touchstart', resumeOnce, true);
    }); 
  }
  else{ 
    pauseAllBGM(); 
    bgmBtn.textContent="â™ª BGM ON"; 
    bgmBtn.classList.remove('active');
  }
})();

/* â˜…SEå†ç”Ÿã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆé–¢æ•° */
const onClickSE = ()=>Sound.play('push', .9);

/* ===== DOM & åŸºæœ¬è¨­å®šï¼ˆA åŸºæº–ï¼‰ ===== */
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d", { alpha:true });
const $pauseBtn = document.getElementById("pauseBtn");
const $score = document.getElementById("score");
const $rank = document.getElementById("rank");
let $rankProgress = document.getElementById("rankProgress");
const $status = document.getElementById("status");
/* â˜…IDã‚’char-modalã‹ã‚‰charModalã«å¤‰æ›´ */
const $charModal = document.getElementById("charModal");
const $charList = document.getElementById("char-list");

/* â˜…ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ¡ãƒ‹ãƒ¥ãƒ¼DOM */
const $indexBtn = document.getElementById('indexBtn');
const $indexModal = document.getElementById('indexModal');
const $openHowtoBtn = document.getElementById('openHowtoBtn');
const $btnCharIntroIndex = document.getElementById('btnCharIntroIndex');

/* â˜…ãƒªã‚»ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«DOM */
const $resetConfirmModal = document.getElementById('resetConfirmModal');

/* â˜…æ“ä½œèª¬æ˜ãƒ¢ãƒ¼ãƒ€ãƒ«DOM (Howto) */
const $howtoModal = document.getElementById('howtoModal');
const $howtoImg = document.getElementById('howtoImg');
const $howtoCounter = document.getElementById('howtoCounter');
const $howtoPrev = document.getElementById('howtoPrev');
const $howtoNext = document.getElementById('howtoNext');


const size = 7;
let logicalSize = 400;
let tileSize = logicalSize/size;
let DPR = Math.max(1, Math.min(3, Math.floor(window.devicePixelRatio || 1)));
let paused = false;
let isKanki = true;
const DRAG_THRESHOLD = 0.35;

/* ===== ç”»åƒ (çœç•¥: å¤‰æ›´ãªã—) ===== */
const IMG = { 
  "SANZU": new Image(), "MUTSU": new Image(), "HANZO": new Image(), "CHIEKO": new Image(), "KUJAKU": new Image(),
  "S_BIR": new Image(), "S_NE0": new Image(), "S_SHU": new Image(), "S_REQ": new Image(), "S_UNK": new Image(),
  "J_NEM": new Image(), "J_SHI": new Image(), "J_PRO": new Image(),
  "PATH_SANZU": "images/sanzu.png",
  "PATH_MUTSU": "images/mutsu.png",
  "PATH_HANZO": "images/hanzo.png",
  "PATH_CHIEKO": "images/chieko.png",
  "PATH_KUJAKU": "images/kujaku.png",
  "PATH_S_BIR": "images/special_bir.png",
  "PATH_S_NE0": "images/special_ne0.png",
  "PATH_S_SHU": "images/special_shu.png",
  "PATH_S_REQ": "images/special_req.png",
  "PATH_S_UNK": "images/special_unk.png",
  "PATH_J_NEM": "images/nemu.png",
  "PATH_J_SHI": "images/shinjuro.png",
  "PATH_J_PRO": "images/propaganda.png",
  "BG": new Image(), "PATH_BG": "images/boad_bg.png"
};
function loadImages(done){ 
  let loaded=0; const keys=Object.keys(IMG).filter(k=>!k.startsWith('PATH_')); const total=keys.length;
  if(total===0){ done(); return; }
  keys.forEach(k=>{ IMG[k].onload=()=>{ if(++loaded===total) done(); }; IMG[k].onerror=()=>{ if(++loaded===total) done(); };
    const p=IMG["PATH_"+k]; if(p) IMG[k].src=p; });
}

/* ===== ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å›³é‘‘ (çœç•¥: å¤‰æ›´ãªã—) ===== */
const CHARACTERS = [ 
  { sym: "CHIEKO", name: "ç¾æ¯’ä¸¸", tag: "é€šå¸¸", desc: "ä¿®ç¾…ç‹ä¸¸ã®æœ€å¤ã®å¼ç¥ã€‚åŸºç¤çš„ãªæš—èºã‚’æ‹…ã†ã€‚", image: "CHIEKO", unlock: { key: "initial" } },
  { sym: "SANZU", name: "ä¸‰é€”", tag: "é€šå¸¸", desc: "ä¿®ç¾…ç‹ä¸¸ã®çŸ›ãŸã‚‹å¼ç¥ã€‚åŸºç¤çš„ãªæš—èºã‚’æ‹…ã†ã€‚", image: "SANZU", unlock: { key: "initial" } },
  { sym: "HANZO", name: "ãƒãƒ³ã‚¾ã‚¦", tag: "é€šå¸¸", desc: "ä¿®ç¾…ç‹ä¸¸ã®å…ˆé™£ãŸã‚‹å¼ç¥ã€‚åŸºç¤çš„ãªæš—èºã‚’æ‹…ã†ã€‚", image: "HANZO", unlock: { key: "initial" } },
  { sym: "MUTSU", name: "é™¸å¥¥æ€ªç«¥", tag: "é€šå¸¸", desc: "ä¿®ç¾…ç‹ä¸¸ã®ç›¾ãŸã‚‹å¼ç¥ã€‚åŸºç¤çš„ãªæš—èºã‚’æ‹…ã†ã€‚", image: "MUTSU", unlock: { key: "initial" } },
  { sym: "KUJAKU", name: "ã‚¯ã‚¸ãƒ£ã‚¯", tag: "é€šå¸¸", desc: "ä¿®ç¾…ç‹ä¸¸ã®ç›Ÿç´„ãŸã‚‹å¼ç¥ã€‚åŸºç¤çš„ãªæš—èºã‚’æ‹…ã†ã€‚", image: "KUJAKU", unlock: { key: "initial" } },

  { sym: "S_BIR", name: "ä¿®ç¾…ç‹ä¸¸ãƒ»ãƒŸãƒŸãƒƒã‚¯", tag: "ç‰¹æ®Š", desc: "ã‹ã¤ã¦äººã¨å…±ã«åœ¨ã£ãŸä¿®ç¾…ç‹ä¸¸ã€‚ç¸¦åˆ—ã‚’æ¶ˆå»ã™ã‚‹ã€‚", image: "S_BIR", unlock: { key: "rank", value: 0 } }, /* 0ã«ä¿®æ­£ */
  { sym: "S_NE0", name: "ä¿®ç¾…ç‹ä¸¸ãƒ»ãƒã‚ªãƒ¬ãƒˆãƒ­", tag: "ç‰¹æ®Š", desc: "äººã®å§¿ã‚’è¾ã‚ãŸä¿®ç¾…ç‹ä¸¸ã€‚ç¸¦åˆ—æ¶ˆå»ï¼ˆåå­—å¼·åŒ–ãƒ¢ãƒ¼ãƒ‰ã§ç¸¦åˆ—+ä¸¡éš£ï¼‰ã€‚", image: "S_NE0", unlock: { key: "rank", value: 1 } },
  { sym: "S_SHU", name: "ä¿®ç¾…ç‹ä¸¸ãƒ»ã‚·ãƒ³ã‚®ãƒ¥ãƒ©", tag: "ç‰¹æ®Š", desc: "ãƒã‚ªãƒ¬ãƒˆãƒ­ã‚’æ–¬ã‚Šæ¨ã¦é¡•ç¾ã—ãŸå­˜åœ¨ã€‚åºƒç¯„å›²ã‚’å††å½¢ã«æ¶ˆå»ã™ã‚‹ã€‚", image: "S_SHU", unlock: { key: "rank", value: 2 } },
  { sym: "S_REQ", name: "ä¿®ç¾…ç‹ä¸¸ãƒ»ãƒ¬ã‚¯ã‚¤ã‚¨ãƒ ", tag: "ç‰¹æ®Š", desc: "æ–°ãŸãªå¢ƒåœ°ã‚’æ±‚ã‚ã¦ç”Ÿã¾ã‚ŒãŸå­˜åœ¨ã€‚æ¨ªåˆ—æ¶ˆå»ï¼ˆåå­—å¼·åŒ–ãƒ¢ãƒ¼ãƒ‰ã§æ¨ªåˆ—+ä¸Šä¸‹éš£ï¼‰ã€‚", image: "S_REQ", unlock: { key: "rank", value: 3 } },
  { sym: "S_UNK", name: "ä¿®ç¾…ç‹ä¸¸ãƒ»ã‚¢ãƒ³ãƒã‚¦ãƒ³", tag: "ç‰¹æ®Š", desc: "æœªã è¦‹ã¬å…ˆã®å¢ƒåœ°ã€‚æ–œã‚åˆ—ã‚’æ¶ˆå»ã™ã‚‹ï¼ˆåˆ‡ã‚Šæ›¿ãˆå¯èƒ½ï¼‰ã€‚", image: "S_UNK", unlock: { key: "rank", value: 4 } },

  { sym: "J_NEM", name: "åˆæ­“", tag: "æ‚”æ¨", desc: "ä¿®ç¾…ç‹ä¸¸ã‚’æ¨ã‚€å¨˜ã€‚ç§»å‹•ã§ããšã€éš£æ¥ã™ã‚‹æ¶ˆå»ã§HPã‚’å‰Šã‚‹ã€‚HP:1ã€‚", image: "J_NEM", unlock: { key: "juso_spawn", value: true } },
  { sym: "J_SHI", name: "è¾°åéƒ", tag: "æ…™æ„§", desc: "ç­‘å‰å¿å…«å‰£è¡†ã®å‰å…ƒç· ã€‚ç§»å‹•ã§ããšã€éš£æ¥ã™ã‚‹æ¶ˆå»ã§HPã‚’å‰Šã‚‹ã€‚HP:3ã€‚", image: "J_SHI", unlock: { key: "juso_spawn", value: true } },
  { sym: "J_PRO", name: "ãƒ—ãƒ­ãƒ‘ã‚¬ãƒ³ãƒ€", tag: "è„…å¨", desc: "é¡å†™ã—ã®ä¸–ç•Œã«ä½ã‚€æ­£ç¾©ã®ä¿®ç¾…ç‹ä¸¸ã€‚ç§»å‹•ã§ããšã€éš£æ¥ã™ã‚‹æ¶ˆå»ã§HPã‚’å‰Šã‚‹ã€‚HP:5ã€‚", image: "J_PRO", unlock: { key: "juso_spawn", value: true } },
];
let unlockedChars = store.get("unlockedChars", { initial: true, juso_spawn: false });

function tagClassByChar(ch){ /* (çœç•¥: å¤‰æ›´ãªã—) */
  if (Array.isArray(SPECIALS) && SPECIALS.includes(ch.sym)) return "orange";
  if (ch.sym === "J_NEM") return "yellow";
  if (ch.sym === "J_SHI") return "blue";
  if (ch.sym === "J_PRO") return "red";
  return "neutral";
}
function updateCharModalContent(){ /* (çœç•¥: å¤‰æ›´ãªã—) */
  if(!$charList) return; let html="";
  CHARACTERS.forEach(ch=>{
    let locked=false, note="";
    if(ch.unlock.key==="rank" && rankIndex<ch.unlock.value){ locked=true; note=`Rank ${ch.unlock.value} ã§è§£æ”¾`; }
    else if(ch.unlock.key==="juso_spawn" && !unlockedChars.juso_spawn){ locked=true; note=`å‘ªè©›ãƒ–ãƒ­ãƒƒã‚¯ã®å‡ºç¾ã§è§£æ”¾`; }
    const src = IMG["PATH_"+(ch.image||ch.sym)] || "";
    const tagHtml = `<span class="char-tag ${tagClassByChar(ch)}">${ch.tag}</span>`;
 if(locked){

  // â˜…ãƒ–ãƒ©ã‚¤ãƒ³ãƒ‰ï¼šåå‰/ã‚¿ã‚°/èª¬æ˜/è§£æ”¾æ¡ä»¶ã‚’éš ã™
  html += `<div class="char-item locked">
    <div class="title-row">
      <!-- ç”»åƒã¯CSSã§æ¶ˆã—ã€ãƒ€ãƒŸãƒ¼æ ã¯::beforeã§è¡¨ç¤º -->
      <h4>ï¼Ÿï¼Ÿï¼Ÿ</h4>
    </div>
  </div>`;
}else{
  html += `<div class="char-item unlocked">
    <div class="title-row"><img src="${src}" onerror="this.style.display='none';" alt="">
      <h4>${ch.name} ${tagHtml}</h4>
    </div>
    <p>${ch.desc}</p>
  </div>`;
}
  });
  $charList.innerHTML=html;
}

/* --- â˜…ã“ã“ã‹ã‚‰ä¿®æ­£ --- */

let wasPausedBeforeIndex = false; // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’é–‹ãå‰ã®ãƒãƒ¼ã‚ºçŠ¶æ…‹ã‚’ä¿å­˜
let wasPausedBeforeChildModal = false; // å­ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå›³é‘‘/æ“ä½œèª¬æ˜ï¼‰ã‚’é–‹ãå‰ã®ãƒãƒ¼ã‚ºçŠ¶æ…‹ã‚’ä¿å­˜
let isIndexOpen = false;

/* â˜…ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–¢é€£ */
function openIndexModal(){
  // â˜…é–‹ãï¼šindex ã ã‘ï¼ˆãªã‘ã‚Œã° push ã«1å›ã ã‘ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  try {
    if (Sound && Sound.play) {
      Sound.play('index');           // â† ã“ã“ã ã‘ã§OK
    } else if (typeof onClickSE === 'function') {
      onClickSE();                   // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆ1å›ã ã‘ï¼‰
    }
  } catch(e) {}

  if (!isIndexOpen) { // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒé–‰ã˜ã¦ã„ã‚‹å ´åˆã®ã¿ã€ãƒãƒ¼ã‚ºçŠ¶æ…‹ã‚’ä¿å­˜
    wasPausedBeforeIndex = paused;
    if (!paused) togglePause();
    isIndexOpen = true;
  }
  $indexModal.hidden = false;
  $indexModal.classList.add('open');
}

function closeIndexModal(){
  // â˜…é–‰ã˜ã‚‹ï¼špushï¼ˆonClickSEï¼‰ã ã‘
  try { if (typeof onClickSE === 'function') onClickSE(); } catch(e) {}

  $indexModal.hidden = true;
  $indexModal.classList.remove('open');
  isIndexOpen = false;

  // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’é–‹ãå‰ã®çŠ¶æ…‹ã«æˆ»ã™
  if (paused && !wasPausedBeforeIndex) {
    togglePause();
  }
}


/* â˜…ã‚­ãƒ£ãƒ©å›³é‘‘ã‚’é–‹ããƒ»é–‰ã˜ã‚‹ */
function openCharModal(){ 
  // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒé–‹ã„ã¦ã„ã‚‹å‰æ
  wasPausedBeforeChildModal = paused; 
  if (!paused) togglePause();
  
  updateCharModalContent(); 
  $charModal.classList.add("open"); 
  $charModal.hidden = false;
  $indexModal.style.filter = "blur(4px)"; // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ã¼ã‹ã—ã¦å¥¥ã«ã‚ã‚‹ã‚ˆã†ã«è¦‹ã›ã‚‹ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
}
function closeCharModal(){
   onClickSE && onClickSE(); try{ window.playSEPush && window.playSEPush(); }catch(e){};
 
  $charModal.classList.remove("open"); 
  $charModal.hidden = true;
  $indexModal.style.filter = "none";
  
  // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒé–‹ã„ã¦ã„ã‚Œã°ã€ãƒãƒ¼ã‚ºçŠ¶æ…‹ã¯ç¶­æŒï¼ˆã‚²ãƒ¼ãƒ ã¯ãƒãƒ¼ã‚ºã®ã¾ã¾ï¼‰
  if (isIndexOpen) {
    // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒé–‹ã„ã¦ã„ã‚‹ãŸã‚ã€ä½•ã‚‚ã—ãªã„ï¼ˆpaused = trueã®ã¾ã¾ï¼‰
    return;
  }

  // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒé–‰ã˜ã¦ã„ã‚Œã°ã€ã‚²ãƒ¼ãƒ é–‹å§‹å‰ã®çŠ¶æ…‹ã«æˆ»ã™
  if (paused && !wasPausedBeforeChildModal) { 
    togglePause(); 
  }
}

/* â˜…æ“ä½œèª¬æ˜ã®ãƒ‡ãƒ¼ã‚¿ */
const HOWTO_IMAGES = [
  "images/howto1.png",
  "images/howto2.png",
  "images/howto3.png"
];
const HOWTO_CAPTIONS = [
  "æ“ä½œæ–¹æ³•1",
  "æ“ä½œæ–¹æ³•2",
  "æ“ä½œæ–¹æ³•3"
];
let howtoIdx = 0;

function showHowtoPage(i){
  const len = HOWTO_IMAGES.length;
  if(len === 0){
    $howtoImg.src = "";
    $howtoImg.alt = "æ“ä½œèª¬æ˜ã®ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
    $howtoCounter.textContent = "0 / 0";
    $howtoPrev.style.display = $howtoNext.style.display = 'none';
    return;
  }

  howtoIdx = (i + len) % len;
  $howtoImg.src = HOWTO_IMAGES[howtoIdx];
  $howtoImg.alt = HOWTO_CAPTIONS[howtoIdx] || "æ“ä½œèª¬æ˜";
  $howtoCounter.textContent = `${howtoIdx + 1} / ${len}`;
  $howtoPrev.style.display = $howtoNext.style.display = '';
}
function prevHowtoPage(){ onClickSE(); showHowtoPage(howtoIdx - 1); }
function nextHowtoPage(){ onClickSE(); showHowtoPage(howtoIdx + 1); }

/* â˜…æ“ä½œèª¬æ˜ã‚’é–‹ããƒ»é–‰ã˜ã‚‹ (Howtoã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã‹ã‚‰ã‚‚å‘¼ã³å‡ºã•ã‚Œã‚‹ãŸã‚ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«é–¢æ•°ã‚’å®šç¾©) */
window.openHowto = function(){ 
  wasPausedBeforeChildModal = paused; 
  if (!paused) togglePause();

  const modal = document.getElementById("howtoModal");
  modal.removeAttribute("hidden");  // â† hiddenå±æ€§ã‚’é™¤å»
  modal.style.display = "flex";     // â† è¡¨ç¤ºã‚’å¼·åˆ¶
  modal.classList.add("open");

  showHowtoPage(0); // â† æœ€åˆã®ãƒšãƒ¼ã‚¸ã‚’ç¢ºå®Ÿã«è¡¨ç¤º

  // $indexModal.style.filter = "blur(4px)"; // â† ãƒ–ãƒ©ãƒ¼ã‚’ç„¡åŠ¹åŒ–

  window.addEventListener('keydown', onHowtoKey, {passive:true});
};

window.closeHowto = function(){ 
  $howtoModal.hidden = true; 
  $howtoModal.classList.remove("open");
  $indexModal.style.filter = "none";
  
  // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤
  window.removeEventListener('keydown', onHowtoKey);
  
  // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒé–‹ã„ã¦ã„ã‚Œã°ã€ãƒãƒ¼ã‚ºçŠ¶æ…‹ã¯ç¶­æŒï¼ˆã‚²ãƒ¼ãƒ ã¯ãƒãƒ¼ã‚ºã®ã¾ã¾ï¼‰
  if (isIndexOpen) {
    // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒé–‹ã„ã¦ã„ã‚‹ãŸã‚ã€ä½•ã‚‚ã—ãªã„ï¼ˆpaused = trueã®ã¾ã¾ï¼‰
    return;
  }

  // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒé–‰ã˜ã¦ã„ã‚Œã°ã€ã‚²ãƒ¼ãƒ é–‹å§‹å‰ã®çŠ¶æ…‹ã«æˆ»ã™
  if (paused && !wasPausedBeforeChildModal) { 
    togglePause(); 
  }
}

/* Howtoã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ */
function onHowtoKey(e){
  if(e.key==='ArrowLeft') prevHowtoPage();
  else if(e.key==='ArrowRight') nextHowtoPage();
  else if(e.key==='Escape') window.closeHowto();
}


/* ===== è¦šé†’ãƒªã‚»ãƒƒãƒˆé–¢é€£ (æ–°è¦) ===== */
function openResetConfirmModal(){
  $indexModal.hidden = true; // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’é–‰ã˜ã‚‹
  $resetConfirmModal.hidden = false;
}
function closeResetConfirmModal(){
  $resetConfirmModal.hidden = true;
  $indexModal.hidden = false; // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«æˆ»ã‚‹
}
function resetRank(){
  closeResetConfirmModal();
  // ãƒ©ãƒ³ã‚¯ã€é€²æ—ã€ã‚¹ã‚³ã‚¢ã‚’ãƒªã‚»ãƒƒãƒˆ
  score = 0;
  rankIndex = 0;
  rankProgress = 0;
  store.set("score",score);
  store.set("rankIndex",rankIndex);
  store.set("rankProgress",rankProgress);

  // ç›¤é¢ã‚’åˆæœŸåŒ–ï¼ˆæ—¢å­˜æç”»ã¯æ¶ˆãˆã‚‹ï¼‰
  initGame(true);

  // ---- å†æç”»å¯¾ç­–ï¼šé™æ­¢çŠ¶æ…‹ã§ä¸€æšã ã‘æç”» ----
  // ã‚¢ãƒ‹ãƒ¡çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢ã—ã¦è½ä¸‹ç­‰ã‚’æŠ‘æ­¢
  if (typeof animState === "undefined" || animState === null) { try{ animState = "idle"; }catch(e){} }
  animState = "idle";

  if (typeof size === "undefined" || size === null) { try{ size = 7; }catch(e){} } // å¿µã®ãŸã‚
  if (typeof yAnim === "undefined" || !yAnim) yAnim = [];
  if (typeof yVel  === "undefined" || !yVel ) yVel  = [];

  for (let r = 0; r < size; r++) {
    if (!yAnim[r]) yAnim[r] = [];
    if (!yVel[r])  yVel[r]  = [];
    for (let c = 0; c < size; c++) {
      yAnim[r][c] = 0;
      yVel[r][c]  = 0;
    }
  }

  // ãƒãƒ¼ã‚ºä¸­ã¯ãƒ«ãƒ¼ãƒ—å†é–‹ã›ãšã«ä¸€åº¦ã ã‘æç”»ã€‚ãƒãƒ¼ã‚ºã§ãªã‘ã‚Œã°é€šå¸¸ãƒ«ãƒ¼ãƒ—
  try {
    if (typeof paused !== "undefined" && paused) {
      if (typeof drawGame === "function") drawGame();
    } else {
      if (typeof gameLoop === "function") gameLoop();
    }
  } catch(e){ /* no-op */ }

  // UIæ›´æ–°ãƒ»ãƒœã‚¤ã‚¹é¡
  try { if (typeof updateScoresUI === "function") updateScoresUI(); } catch(e){}
  try { if (typeof updateStatus === "function") updateStatus("status: è¦šé†’ãƒ©ãƒ³ã‚¯ã¨æš—èºå€¤ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚"); } catch(e){}
  try {
    var v = document.getElementById("vo_reset");
    if(v){ v.currentTime = 0; v.play && v.play().catch(()=>{}); }
  } catch(e){}
}


/* ===== ãƒ©ãƒ³ã‚¯ãƒ»ç¨®åˆ¥ (çœç•¥: å¤‰æ›´ãªã—) ===== */
const RANKS = [ /* (çœç•¥: å¤‰æ›´ãªã—) */
  { key:"S_BIR", name:"ãƒŸãƒŸãƒƒã‚¯", score: 100 },
  { key:"S_NE0", name:"ãƒã‚ªãƒ¬ãƒˆãƒ­", score: 200 },
  { key:"S_SHU", name:"ã‚·ãƒ³ã‚®ãƒ¥ãƒ©", score: 300 },
  { key:"S_REQ", name:"ãƒ¬ã‚¯ã‚¤ã‚¨ãƒ ", score: 400 },
  { key:"S_UNK", name:"ã‚¢ãƒ³ãƒã‚¦ãƒ³", score: 500 }
];
const MAX_RANK_INDEX = RANKS.length - 1;
const NORMALS=["SANZU","MUTSU","HANZO","CHIEKO","KUJAKU"];
const SPECIALS=RANKS.map(r=>r.key);
const JUSOS=["J_NEM", "J_SHI", "J_PRO"];
const RANK_THRESH = [3, 3, 3, 3, 2];//ãƒ©ãƒ³ã‚¯ã‚¢ãƒƒãƒ—é—˜å€¤
const SPECIAL_POINTS = { "S_BIR": 10, "S_NE0": 20, "S_SHU": 30, "S_REQ": 40, "S_UNK": 50 };

let board=[], yAnim=[], score=store.get("score",0), rankIndex=store.get("rankIndex",0), rankProgress=store.get("rankProgress",0);
let slashes=[], particles=[]; // Bã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¦ç´ 
let vanishMask=null, vanishP=0, animState="idle";
let drag={active:false,start:null,t:null}, swapPair=null;
let jusoHP=[], currentObstacleCount=0;
let jusoShake=[]; // 0..1 ã®æ¸›è¡°ãƒ‘ãƒ¯ãƒ¼

let isBgmReady = false; // BGMã®æº–å‚™å®Œäº†ãƒ•ãƒ©ã‚°

/* â˜…ãƒ©ãƒ³ã‚¯MAXåˆ°é”ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ  (æ°¸ç¶šåŒ–) */
let hasReachedMaxRank = store.get("hasReachedMaxRank", false);

/* === æœ€çµ‚ãƒ©ãƒ³ã‚¯ï¼šç‰¹æ®Šãƒ–ãƒ­ãƒƒã‚¯é¸æŠ  === */
let selectedSpecialOverride = null; // nullæ™‚ã¯é€šå¸¸ã®ãƒ©ãƒ³ã‚¯ä¾å­˜
function voiceForSpecial(sym){ /* (çœç•¥: å¤‰æ›´ãªã—) */
  if(sym==="S_BIR") return document.getElementById("vo_rank0");
  if(sym==="S_NE0") return document.getElementById("vo_rank1");
  if(sym==="S_SHU") return document.getElementById("vo_rank2");
  if(sym==="S_REQ") return document.getElementById("vo_rank3");
  if(sym==="S_UNK") return document.getElementById("vo_rank4");
  return null;
}
function stopAllRankVoices(){ /* (çœç•¥: å¤‰æ›´ãªã—) */
  ["vo_rank1","vo_rank2","vo_rank3","vo_rank4"].forEach(id=>{
    const a = document.getElementById(id);
    if(a){ try{ a.pause(); a.currentTime = 0; }catch(_){} }
  });
}

function buildRankSelectButtons(){ /* (çœç•¥: å¤‰æ›´ãªã—) */
  const row = document.getElementById('rankSelectRow');
  if(!row || row.dataset.built==="1") return;
  const specials = ["S_BIR","S_NE0","S_SHU","S_REQ","S_UNK"];
  specials.forEach(sym=>{
    const btn = document.createElement('button');
    btn.className = 'btn-icon';
    const img = document.createElement('img');
    img.src = IMG["PATH_"+sym] || "";
    img.alt = sym;
    btn.appendChild(img);
    btn.addEventListener('click', ()=>{
      if(!hasReachedMaxRank) return; // â˜…ãƒã‚§ãƒƒã‚¯ã‚’hasReachedMaxRankã«å¤‰æ›´
      selectedSpecialOverride = sym;
      [...row.children].forEach(el=>el.classList.remove('active'));
      btn.classList.add('active');

      stopAllRankVoices();
      const v = voiceForSpecial(sym);
      if(v){ try{ v.currentTime=0; v.play().catch(()=>{}); }catch(_){} }

    });
    row.appendChild(btn);
  });
  row.dataset.built="1";
}
/* ===== RankMAX (Rank 5) ã®åç§°å®šç¾© ===== */
// NORMALSã¨SPECIALSã«ç¶šã„ã¦ã€ãƒ©ãƒ³ã‚¯ã®åç§°ä¸€è¦§ã‚’å®šç¾©ã—ã¾ã™ã€‚
// rankIndex (1-based) ã‹ã‚‰åç§°ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã€é…åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’èª¿æ•´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
// rankIndex 0: ãƒŸãƒŸãƒƒã‚¯
// rankIndex 1: ãƒã‚ªãƒ¬ãƒˆãƒ­
// rankIndex 2: ã‚·ãƒ³ã‚®ãƒ¥ãƒ©
// rankIndex 3: ãƒ¬ã‚¯ã‚¤ã‚¨ãƒ 
// rankIndex 4: ã‚¢ãƒ³ãƒã‚¦ãƒ³
// rankIndex 5: æ°¸é ã®ç„¦åœŸ (Rank MAX)
const RANK_TITLES = [
  "ãƒŸãƒŸãƒƒã‚¯", // rankIndex = 0 or 1 (åˆæœŸå€¤/Rank 1ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹æƒ³å®š)
  "ãƒã‚ªãƒ¬ãƒˆãƒ­", // rankIndex = 1ï½“
  "ã‚·ãƒ³ã‚®ãƒ¥ãƒ©", // rankIndex = 2
  "ãƒ¬ã‚¯ã‚¤ã‚¨ãƒ ", // rankIndex = 3
  "ã‚¢ãƒ³ãƒã‚¦ãƒ³", // rankIndex = 4 (MAX_RANK_INDEXã«ç›¸å½“)
  "æ°¸é ã®ç„¦åœŸ" // rankIndex = 5 (Rank MAX)
];

// rankIndexã‹ã‚‰ãƒ©ãƒ³ã‚¯åã‚’å–å¾—ã™ã‚‹ãŸã‚ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function getRankName(index) {
  // rankIndexãŒé…åˆ—ã®ç¯„å›²å¤–ã®å ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  if (index < 0 || index >= RANK_TITLES.length) {
    return `Rank ${index}`;
  }
  return RANK_TITLES[index];
}

function updateStatus(text){ if($status) $status.textContent=text; }
function updateScoresUI(){
  // æš—èºå€¤
  $score.textContent = `æš—èºå€¤: ${score}`;
  // å³ä¸Šãƒ©ãƒ³ã‚¯ï¼ˆAï¼‰
  const label = (rankIndex===MAX_RANK_INDEX && hasReachedMaxRank) ? `ä¿®ç¾…ç‹ä¸¸: æ°¸é ã®ç„¦åœŸ ` : `ä¿®ç¾…ç‹ä¸¸: ${RANKS[rankIndex].name} `;
  if ($rank.firstChild) $rank.firstChild.textContent = label; else $rank.textContent = label;
  $rankProgress = document.getElementById("rankProgress") || (()=>{
    const sp=document.createElement('span'); sp.className='rank-progress'; sp.id='rankProgress'; $rank.appendChild(sp); return sp;
  })();
  if (rankIndex===MAX_RANK_INDEX){
    $rankProgress.textContent = hasReachedMaxRank ? 'MAX' : `(${unknownStageProgress}/${UNKNOWN_THRESH})`;
  } else {
    $rankProgress.textContent = `(${rankProgress}/${RANK_THRESH[rankIndex]})`;
  }
  
  // æœ€çµ‚ãƒ©ãƒ³ã‚¯ã§é¸æŠè¡Œã‚’è¡¨ç¤º (ãƒªã‚»ãƒƒãƒˆå¾Œã‚‚éè¡¨ç¤ºã«ã—ãªã„)
  const selRow = document.getElementById('rankSelectRow');
  if(selRow){
    // â˜…ãƒ©ãƒ³ã‚¯MAXã«åˆ°é”ã—ãŸã“ã¨ãŒã‚ã‚Œã°ã€å¸¸ã«ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
    // keep hasReachedMaxRank untilé—˜å€¤é”æˆ; do not auto-set here
    
    if(hasReachedMaxRank){
      buildRankSelectButtons();
      selRow.style.display='';
      /* ãƒ©ãƒ³ã‚¯MAXã§ãªã‘ã‚Œã°ã€ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã‚’ã‚¯ãƒªã‚¢ã—ã€ãƒœã‚¿ãƒ³ã®é¸æŠã‚’å¤–ã™ */
      if(rankIndex!==MAX_RANK_INDEX) { 
        selectedSpecialOverride=null; 
        [...selRow.children].forEach(el=>el.classList.remove('active'));
      }
    }else{
      selRow.style.display='none';
    }
  }
  // æ°¸ç¶š
  store.set("score",score); store.set("rankIndex",rankIndex); store.set("rankProgress",rankProgress);
}

/* ===== ç›¤é¢ (çœç•¥: å¤‰æ›´ãªã—) ===== */
function get(r,c){ return (r>=0 && r<size && c>=0 && c<size) ? board[r][c] : null; }
function set(r,c,v){ if(r>=0 && r<size && c>=0 && c<size) board[r][c]=v; }
function swap(r1,c1,r2,c2){ [board[r1][c1],board[r2][c2]]=[board[r2][c2],board[r1][c1]]; }
function getInitialBlock(){ return NORMALS[Math.floor(Math.random()*NORMALS.length)]; }

function initBoard(){ /* (çœç•¥: å¤‰æ›´ãªã—) */
  board = Array.from({length:size},()=>Array(size).fill(0));
  jusoHP= Array.from({length:size},()=>Array(size).fill(0));
  yAnim = Array.from({length:size},()=>Array(size).fill(0));
  yVel  = Array.from({length:size},()=>Array(size).fill(0));
  jusoShake = Array.from({length:size},()=>Array(size).fill(0));
  for(let r=0;r<size;r++){
    for(let c=0;c<size;c++){
      let b;
      do{ b=getInitialBlock(); }
      while((c>=2 && get(r,c-1)===b && get(r,c-2)===b) || (r>=2 && get(r-1,c)===b && get(r-2,c)===b));
      set(r,c,b);
    }
  }
  currentObstacleCount=0;
  prepareDrop();
}

/* ===== å…¥åŠ› (çœç•¥: å¤‰æ›´ãªã—) ===== */
function getGridPos(x,y){ /* (çœç•¥: å¤‰æ›´ãªã—) */
  const rect=canvas.getBoundingClientRect(), nx=x-rect.left, ny=y-rect.top;
  const scale = logicalSize/rect.width;
  const gc=Math.floor(nx*scale/tileSize), gr=Math.floor(ny*scale/tileSize);
  if(gc<0||gc>=size||gr<0||gr>=size) return null;
  return {r:gr,c:gc};
}
function onStart(x,y){ /* (çœç•¥: å¤‰æ›´ãªã—) */
  userGesture();
  if (paused || animState !== "idle" || swapPair) return;
  const pos=getGridPos(x,y); if(pos){ drag.active=true; drag.start=pos; drag.t={...pos,px:x,py:y}; }
}
function onMove(x,y){ /* (çœç•¥: å¤‰æ›´ãªã—) */
  if(!drag.active || !drag.t) return;
  const rect=canvas.getBoundingClientRect(), scale=logicalSize/rect.width;
  const distSq=(x-drag.t.px)**2+(y-drag.t.py)**2;
  if(distSq<(tileSize*0.35/scale)**2) return;
  const dx=x-drag.t.px, dy=y-drag.t.py;
  let dirX=0, dirY=0;
  if(Math.abs(dx)>Math.abs(dy)) dirX=dx>0?1:-1; else dirY=dy>0?1:-1;
  const {r,c}=drag.start, nr=r+dirY, nc=c+dirX;
  if(nr>=0 && nr<size && nc>=0 && nc<size){
    if (JUSOS.includes(get(r,c)) || JUSOS.includes(get(nr,nc))) {
      // è§¦ã‚ŒãŸJUSOå´ã«å°åˆ»ã¿ã‚·ã‚§ã‚¤ã‚¯
      if (JUSOS.includes(get(r,c)))  triggerJusoShake(r, c, 1.0);
      if (JUSOS.includes(get(nr,nc))) triggerJusoShake(nr, nc, 1.0);
      // æ‹’å¦SE
      if (!window.__seNotCooldown) {
  Sound.play('not', 1.0);
  window.__seNotCooldown = true;
  setTimeout(() => window.__seNotCooldown = false, 300); // 0.3ç§’é–“ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³
}
      return;
    }
    drag.active=false; swapAndStart(r,c,nr,nc);
  }
}
function onEnd(){ drag.active=false; drag.start=null; drag.t=null; }

/* ===== ãƒ¢ãƒ¼ãƒ‰ãƒ»ä¸€æ™‚åœæ­¢(çœç•¥: å¤‰æ›´ãªã—) ===== */
function setMode(mode){ /* (çœç•¥: å¤‰æ›´ãªã—) */
  isKanki=(mode==='kanki');
  document.getElementById("btnKanki").classList.toggle("active",isKanki);
  document.getElementById("btnShodo").classList.toggle("active",!isKanki);
  updateStatus(`status: ãƒ¢ãƒ¼ãƒ‰ã‚’ã€Œ${isKanki?'æ­“å–œ':'ç„¦åœŸ'}ã€ã«è¨­å®šã—ã¾ã—ãŸã€‚`);
}
function togglePause(){ 
  paused=!paused; 
  $pauseBtn.textContent=paused?"â–¶ å†é–‹":"â¸ ä¸€æ™‚åœæ­¢"; 
  if(!paused) gameLoop(); 
}

/* ===== ãƒãƒƒãƒåˆ¤å®šï½æ¶ˆå» (çœç•¥: å¤‰æ›´ãªã—) ===== */
let lastMatchVH={v:false,h:false};
function findMatches(checkOnly=true){ /* (çœç•¥: å¤‰æ›´ãªã—) */
  lastMatchVH={v:false,h:false};
  const matches=new Set(); const isBlocked=(b)=> JUSOS.includes(b) || b===null;
  // ç¸¦
  for(let c=0;c<size;c++) for(let r=0;r<=size-3;r++){
    const b=get(r,c); if(isBlocked(b)) continue;
    let len=1; for(let i=r+1;i<size;i++){ if(get(i,c)===b) len++; else break; }
    if(len>=3){ for(let i=0;i<len;i++) matches.add(`${r+i},${c}`); r+=len-1; lastMatchVH.v=true; }
  }
  // æ¨ª
  for(let r=0;r<size;r++) for(let c=0;c<=size-3;c++){
    const b=get(r,c); if(isBlocked(b)) continue;
    let len=1; for(let i=c+1;i<size;i++){ if(get(r,i)===b) len++; else break; }
    if(len>=3){ for(let i=0;i<len;i++) matches.add(`${r},${c+i}`); c+=len-1; lastMatchVH.h=true; }
  }

  if(checkOnly) return matches.size>0;
  if(matches.size>0){
    vanishMask = matches; animState="vanish"; vanishP=0;
    // æ¶ˆå»SEï¼ˆAï¼‰
    Sound.play('pop',1.0);
    if(lastMatchVH.v) Sound.play('vertical', .9);
    if(lastMatchVH.h) Sound.play('horizontal', .9);
    // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”Ÿæˆï¼ˆBé¢¨ï¼šæ–¬æ’ƒï¼‹ç²’å­ï¼‰
    createSlashEffects(matches);
    createParticles(matches);
    return true;
  }
  return false;
}

/* ãƒ©ãƒ³ã‚¯é€²æ—ãƒ»ãƒœã‚¤ã‚¹ (çœç•¥: å¤‰æ›´ãªã—) */
function updateRank(){ /* (çœç•¥: å¤‰æ›´ãªã—) */
  if(rankIndex<MAX_RANK_INDEX && rankProgress>=RANK_THRESH[rankIndex]){
    rankProgress=0; rankIndex++;
    /* ensure Unknown gate resets */
    try{ 
      if (typeof MAX_RANK_INDEX!=='undefined' && rankIndex===MAX_RANK_INDEX){ 
        if (typeof hasReachedMaxRank!=='undefined'){ hasReachedMaxRank = false; try{ store.set('hasReachedMaxRank', false); }catch(_){} }
        if (typeof unknownStageProgress==='undefined' || typeof unknownStageProgress!=='number') unknownStageProgress = 0; 
        else unknownStageProgress = 0;
        try{ if (typeof store!=='undefined' && store.set) store.set('unknownStageProgress', 0); }catch(_){}
      } 
    }catch(_){}

    const v = document.getElementById(`vo_rank${Math.min(rankIndex,4)}`);
    if(v){ try{ v.currentTime=0; v.play().catch(()=>{}); }catch(_){} }
    Sound.play('bell', 1.0); // ãƒ©ãƒ³ã‚¯ã‚¢ãƒƒãƒ—æ™‚ã€é˜ã‚’åŒæ™‚å†ç”Ÿ
  }
  if(rankIndex>=1 && !unlockedChars.juso_spawn){ unlockedChars.juso_spawn=true; store.set("unlockedChars", unlockedChars); }
  updateScoresUI();
}

/* æ¶ˆå»â†’è½ä¸‹ (çœç•¥: å¤‰æ›´ãªã—) */
const SEED_BASE_CHANCE = 0.06;

function addCell(set, r, c){ /* (çœç•¥: å¤‰æ›´ãªã—) */
  if(r>=0 && r<size && c>=0 && c<size) set.add(`${r},${c}`);
}
function applySpecialGimmicks(baseMatches){ /* (çœç•¥: å¤‰æ›´ãªã—) */
  const extra = new Set();
  baseMatches.forEach(pos=>{
    const [r,c]=pos.split(',').map(Number);
    const b=get(r,c);
    if(!b || !SPECIALS.includes(b)) return;

    if(b==="S_BIR"){ // ç¸¦åˆ—
      for(let rr=0; rr<size; rr++) addCell(extra, rr, c);
    }
    else if(b==="S_NE0"){ // ç¸¦åˆ— (+ç„¦åœŸã§ä¸¡éš£ã®åˆ—)
      for(let rr=0; rr<size; rr++) addCell(extra, rr, c);
      if(!isKanki){ for(let rr=0; rr<size; rr++){ addCell(extra, rr, c-1); addCell(extra, rr, c+1); } }
    }
    else if(b==="S_SHU"){ // å††å½¢ï¼ˆåŠå¾„2ï¼‰
      for(let rr=r-2; rr<=r+2; rr++) for(let cc=c-2; cc<=c+2; cc++){
        const dx=cc-c, dy=rr-r;
        if(dx*dx+dy*dy<=4) addCell(extra, rr, cc);
      }
    }
    else if(b==="S_REQ"){ // æ¨ªåˆ— (+ç„¦åœŸã§ä¸Šä¸‹ã®è¡Œ)
      for(let cc=0; cc<size; cc++) addCell(extra, r, cc);
      if(!isKanki){ for(let cc=0; cc<size; cc++){ addCell(extra, r-1, cc); addCell(extra, r+1, cc); } }
    }
    else if(b==="S_UNK"){ // æ–œã‚Ã—2
      for(let k=-size; k<=size; k++){
        addCell(extra, r+k, c+k);
        addCell(extra, r+k, c-k);
      }
    }
  });
  return extra;
}

function resolveVanishAndDrop(){ /* (çœç•¥: å¤‰æ›´ãªã—) */
  if(!vanishMask) return;
 // â˜…åŒä¸€ vanish ã‚µã‚¤ã‚¯ãƒ«ä¸­ã«åŒã˜ãŠé‚ªé­”ã¸è¤‡æ•°å›ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å…¥ã‚Œãªã„ãŸã‚ã®ãƒ¡ãƒ¢
  const damagedThisVanish = new Set();
  const specialsHit = new Set();
  vanishMask.forEach(pos=>{
    const [r,c] = pos.split(',').map(Number);
    const b = get(r,c);
    if (b && SPECIALS.includes(b)) specialsHit.add(b);
  });
  specialsHit.forEach(sym=>{
    if (sym==="S_BIR" || sym==="S_NE0")      Sound.play('vertical', 0.9);
    else if (sym==="S_REQ")                  Sound.play('horizontal', 0.9);
    else if (sym==="S_SHU")                  Sound.play('circle', 1.0);
    else if (sym==="S_UNK")                  Sound.play('cross', 1.0);
  });

  /* === Unknown é—˜å€¤ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆï¼ˆMAXç›´å‰ã®ã¿ï¼‰ === */
  try{
    if (specialsHit && specialsHit.has && specialsHit.has("S_UNK")){
      if (typeof rankIndex!=='undefined' && typeof MAX_RANK_INDEX!=='undefined' && rankIndex===MAX_RANK_INDEX && !hasReachedMaxRank){
        if (typeof unknownStageProgress!=='number') unknownStageProgress = Number(unknownStageProgress)||0;
        unknownStageProgress += 1;
        try{ if (typeof store!=='undefined' && store.set) store.set('unknownStageProgress', unknownStageProgress); }catch(_){}
        try{ if (typeof updateScoresUI==='function') updateScoresUI(); }catch(_){}
        try{ if (typeof maybeReachMax==='function') maybeReachMax(); }catch(_){}
      }
    }
  }catch(_){}


  const extra = applySpecialGimmicks(vanishMask);
  extra.forEach(p=> vanishMask.add(p));
  if (extra.size) { createSlashEffects(extra); createParticles(extra); }

  vanishMask.forEach(pos=>{
    const [r,c]=pos.split(',').map(Number);
    const b=get(r,c);
    if(b){
      score += 10;
      if(SPECIALS.includes(b)){
        score += SPECIAL_POINTS[b];
      }
    }
    for(let dr=-1; dr<=1; dr++){
      for(let dc=-1; dc<=1; dc++){
        if(!dr && !dc) continue;
        const tr=r+dr, tc=c+dc;
        if(JUSOS.includes(get(tr,tc)) && jusoHP[tr][tc]>0){
        // â˜…åŒã˜åº§æ¨™ã«ã“ã®ã‚µã‚¤ã‚¯ãƒ«ã§æ—¢ã«å½“ã¦ã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
        const key = tr + ',' + tc;
        if (!damagedThisVanish.has(key)) {
        jusoHP[tr][tc]--;
        damagedThisVanish.add(key);
        triggerJusoShake(tr, tc, 1.0);
        }
          if (jusoHP[tr][tc]===0){
            // â˜…ã“ã®ã‚»ãƒ«ã¯ã€Œæ¶ˆå»ã«ã‚ˆã‚‹nullåŒ–ã€ã ã¨ãƒãƒ¼ã‚¯ã™ã‚‹
            (window.__jusoEraseSet ||= new Set()).add(tr + ',' + tc);
            set(tr,tc,null);
            jusoHP[tr][tc] = 0;
            score += 100;
            Sound.play('vertical');
          } else {
            Sound.play('rumble');
          }
        }
      }
    }
    if (JUSOS.includes(b)) { jusoHP[r][c] = 0; }
    set(r,c,null);
  });

  if (specialsHit.size > 0) {
    rankProgress++;
  }

  const prevRank = rankIndex;
  updateRank();

  if(rankIndex > prevRank){
    const all = new Set();
    for(let r=0;r<size;r++){
      for(let c=0;c<size;c++){
        if(get(r,c)!==null) all.add(`${r},${c}`);
      }
    }
    if(all.size>0){
      vanishMask = all;
      animState = "vanish";
      vanishP = 0;
      lastMatchVH.v = true;
      lastMatchVH.h = false;
      createSlashEffects(all);
      return;
    }
  }

  vanishMask = null;
  prepareDrop();
  animState = "drop";
  maybeSpawnObstacles();
}

/* â˜…ã‚¯ãƒƒã‚·ãƒ§ãƒ³è½ä¸‹ç”¨ã®é€Ÿåº¦é…åˆ—ã¨å®šæ•° (çœç•¥: å¤‰æ›´ãªã—) */
let yVel = [];
const GRAVITY = 0.045;
const BOUNCE  = 0.25;
const VEL_EPS = 0.6;

function prepareDrop(){ /* (çœç•¥: å¤‰æ›´ãªã—) */
  for(let c=0;c<size;c++){
    let empty=size-1;
    for(let r=size-1;r>=0;r--){
      const b=get(r,c);
      if(b!==null){
        if(r!==empty){
          set(empty,c,b); set(r,c,null);
          if (!jusoHP[empty]) jusoHP[empty] = [];
          if (!jusoHP[r])     jusoHP[r]     = [];
          jusoHP[empty][c] = jusoHP[r][c] || 0;
          jusoHP[r][c] = 0;
          if(!yAnim[empty]) yAnim[empty]=[];
          if(!yVel[empty])  yVel[empty] =[];
          yAnim[empty][c] = -(empty-r)*tileSize;
          yVel[empty][c]  = 0;
          if(!yVel[r]) yVel[r]=[];
          yVel[r][c]=0;
        }
        empty--;
      }
    }
  }
  for(let c=0;c<size;c++){
    let emptyCount=0;
    for(let r=0;r<size;r++) if(get(r,c)===null) emptyCount++;
    for(let r=0;r<emptyCount;r++){
      let nb=getInitialBlock();
      if(Math.random()<SEED_BASE_CHANCE){
        nb = (rankIndex===MAX_RANK_INDEX && selectedSpecialOverride)
             ? selectedSpecialOverride
             : SPECIALS[Math.min(rankIndex, SPECIALS.length-1)];
        Sound.play('shine', 0.7);
      }
      set(r,c,nb);
      if (!jusoHP[r]) jusoHP[r] = [];
      jusoHP[r][c] = 0;
      if(!yAnim[r]) yAnim[r]=[];
      if(!yVel[r])  yVel[r] =[];
      yAnim[r][c] = -(emptyCount-r)*tileSize;
      yVel[r][c]  = 0;
    }
    for(let r=emptyCount;r<size;r++){
      if(!yAnim[r]) yAnim[r]=[];
      if(!yVel[r])  yVel[r] =[];
      yAnim[r][c] = yAnim[r][c] || 0;
      yVel[r][c]  = yVel[r][c]  || 0;
    }
  }
  Sound.play('whoosh',0.6);
}

/* ãŠé‚ªé­”ç”Ÿæˆ (çœç•¥: å¤‰æ›´ãªã—) */
function maybeSpawnObstacles(){ /* (çœç•¥: å¤‰æ›´ãªã—) */
  if(rankIndex<1) return;
  if(Math.random()>0.16) return;
  const n = 1 + (Math.random()<0.35?1:0);
  let k=0, guard=100;
  while(k<n && guard--){
    const r=Math.floor(Math.random()*size), c=Math.floor(Math.random()*size);
    const cur=get(r,c); if(!cur || JUSOS.includes(cur)) continue;
    const pool = ["J_NEM", "J_SHI", "J_PRO"];
    const pick = pool[Math.floor(Math.random()*pool.length)];
    set(r,c,pick); if(!jusoHP[r]) jusoHP[r]=[]; jusoHP[r][c]=(pick==="J_NEM"?1:(pick==="J_SHI"?3:5)); k++;
  }
}

/* æ–¬æ’ƒï¼†ç²’å­ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ (çœç•¥: å¤‰æ›´ãªã—) */
function createSlashEffects(matches){ /* (çœç•¥: å¤‰æ›´ãªã—) */
  slashes=[];
  matches.forEach(p=>{
    const [r,c]=p.split(',').map(Number);
    const cx=c*tileSize+tileSize/2, cy=r*tileSize+tileSize/2;
    slashes.push({x:cx,y:cy,dir:'h',t:0});
    slashes.push({x:cx,y:cy,dir:'v',t:0});
  });
}
function createParticles(matches){ /* (çœç•¥: å¤‰æ›´ãªã—) */
  particles=[];
  matches.forEach(p=>{
    const [r,c]=p.split(',').map(Number);
    const cx=c*tileSize+tileSize/2, cy=r*tileSize+tileSize/2;
    for(let i=0;i<8;i++){
      particles.push({
        x:cx, y:cy,
        vx:(Math.random()-0.5)*tileSize*0.18,
        vy:(Math.random()-0.5)*tileSize*0.18,
        life:0, maxLife:18
      });
    }
  });
}

/* æç”» (çœç•¥: å¤‰æ›´ãªã—) */
const SWAP_ANIM_TIME=0.15*60, VANISH_ANIM_TIME=0.25*60;
function drawSlashes(){ /* (çœç•¥: å¤‰æ›´ãªã—) */
  if(!slashes.length) return;
  ctx.save();
  ctx.strokeStyle = isKanki ? "rgba(255,255,200,0.8)" : "rgba(200,40,40,0.85)";
  ctx.globalCompositeOperation='lighter';
  for(const s of slashes){
    const t=Math.min(1,s.t); const len=tileSize*(1+t*1.2); const w=Math.max(2,6-t*5);
    ctx.lineWidth=w; ctx.beginPath();
    if(s.dir==='h'){ ctx.moveTo(s.x-len,s.y); ctx.lineTo(s.x+len,s.y); }
    else{ ctx.moveTo(s.x,s.y-len); ctx.lineTo(s.x,s.y+len); }
    ctx.stroke(); s.t+=0.12;
  }
  slashes=slashes.filter(s=>s.t<1.0); ctx.restore();
}
function drawParticles(){ /* (çœç•¥: å¤‰æ›´ãªã—) */
  if(!particles.length) return;
  ctx.save();
  ctx.globalCompositeOperation='lighter';
  for(const p of particles){
    const t=p.life/p.maxLife;
    const alpha = isKanki ? (0.8*(1-t)) : (0.9*(1-t));
    ctx.fillStyle = isKanki ? `rgba(180,220,255,${alpha})` : `rgba(220,40,40,${alpha})`;
    const rad = Math.max(1, 3 - 2*t);
    ctx.beginPath(); ctx.arc(p.x, p.y, rad, 0, Math.PI*2); ctx.fill();
    p.x += p.vx; p.y += p.vy; p.vy += 0.05; p.life++;
  }
  particles=particles.filter(p=>p.life<p.maxLife);
  ctx.restore();
}

function drawBlock(r,c,x,y,a=1){ /* (çœç•¥: å¤‰æ›´ãªã—) */
  const b=get(r,c); if(b===null) return;
  // --- JUSO éœ‡ãˆã‚ªãƒ•ã‚»ãƒƒãƒˆ ---
  if (Array.isArray(JUSOS) && JUSOS.includes(b)) {
    const pow = (jusoShake && jusoShake[r] ? jusoShake[r][c] : 0) || 0;
    if (pow > 0){
      const t = performance.now()/1000;
      const amp = 3 * pow; // æœ€å¤§3pxç›¸å½“æºã‚Œå¼·åº¦
      x += Math.sin(t*36 + (r*7+c)) * amp;
      y += Math.cos(t*36 + (r*11+c)) * amp * 0.6;
    }
  }
  ctx.save(); ctx.globalAlpha=a;
  const img=IMG[b]; const s=tileSize*0.9, off=tileSize*0.05;
  if(img&&img.complete) ctx.drawImage(img,x+off,y+off,s,s);
  else{ ctx.fillStyle='#444'; ctx.fillRect(x,y,tileSize,tileSize); }
  if (JUSOS.includes(b) && jusoHP[r][c] > 0) {
    ctx.fillStyle = 'rgba(255,255,255,0.9)';
    ctx.font = `bold ${tileSize * 0.3}px sans-serif`;
    ctx.textAlign = 'right';
    ctx.textBaseline = 'alphabetic';
    const pad = tileSize * 0.08;
    ctx.fillText(jusoHP[r][c], x + tileSize - pad, y + tileSize - pad);
  }
  ctx.restore();
}

function drawGame(){ /* (çœç•¥: å¤‰æ›´ãªã—) */
  decayJusoShake();
  ctx.clearRect(0,0,logicalSize,logicalSize);
  const bg=IMG.BG; if(bg&&bg.complete&&bg.naturalWidth>0){
    for(let r=0;r<size;r++) for(let c=0;c<size;c++){
      ctx.drawImage(bg,0,0,bg.naturalWidth,bg.naturalHeight,c*tileSize,r*tileSize,tileSize,tileSize);
    }
  }
  if(!isKanki){ ctx.save(); ctx.fillStyle='rgba(60,0,0,0.22)'; ctx.fillRect(0,0,logicalSize,logicalSize); ctx.restore(); }

  for(let r=0;r<size;r++) for(let c=0;c<size;c++){
    if(get(r,c)===null) continue;
    let x=c*tileSize, y=r*tileSize, a=1, ty=0;
    if(animState==="vanish" && vanishMask && vanishMask.has(`${r},${c}`)) a = 1-vanishP;
    if(animState==="drop" && yAnim[r][c]!==0) ty = yAnim[r][c];
    if(animState==="swap" && swapPair){
      const {p1,p2,p,back}=swapPair; const prog=Math.min(1,p/(SWAP_ANIM_TIME)), e=Math.sin(prog*Math.PI/2);
      if(r===p1.r&&c===p1.c){ x+=(back?(p2.c-p1.c)*tileSize*(1-e):(p2.c-p1.c)*tileSize*e);
                               y+=(back?(p2.r-p1.r)*tileSize*(1-e):(p2.r-p1.r)*tileSize*e); }
      if(r===p2.r&&c===p2.c){ x+=(back?(p1.c-p2.c)*tileSize*(1-e):(p1.c-p2.c)*tileSize*e);
                               y+=(back?(p1.r-p2.r)*tileSize*(1-e):(p1.r-p2.r)*tileSize*e); }
    }
    drawBlock(r,c,x,y+ty,a);
  }
  drawSlashes();
  drawParticles();

  if(animState==="swap" && swapPair){
    const {p1,p2,p,back}=swapPair; const prog=Math.min(1,p/(SWAP_ANIM_TIME)), e=Math.sin(prog*Math.PI/2);
    let x1=p1.c*tileSize+(back?(p2.c-p1.c)*tileSize*(1-e):(p2.c-p1.c)*tileSize*e);
    let y1=p1.r*tileSize+(back?(p2.r-p1.r)*tileSize*(1-e):(p2.r-p1.r)*tileSize*e);
    drawBlock(p1.r,p1.c,x1,y1,1);
    let x2=p2.c*tileSize+(back?(p1.c-p2.c)*tileSize*(1-e):(p1.c-p2.c)*tileSize*e);
    let y2=p2.r*tileSize+(back?(p1.r-p2.r)*tileSize*(1-e):(p1.r-p2.r)*tileSize*e);
    drawBlock(p2.r,p2.c,x2,y2,1);
  }
}

/* ã‚¹ãƒ¯ãƒƒãƒ—ï½ãƒ«ãƒ¼ãƒ— (çœç•¥: å¤‰æ›´ãªã—) */
function canSwapAndMatch(r1,c1,r2,c2){ /* (çœç•¥: å¤‰æ›´ãªã—) */
  if(JUSOS.includes(get(r1,c1))||JUSOS.includes(get(r2,c2))){
    if (JUSOS.includes(get(r1,c1))) triggerJusoShake(r1,c1, 1.0);
    if (JUSOS.includes(get(r2,c2))) triggerJusoShake(r2,c2, 1.0);
    Sound.play('not', 1.0);
    return false;
  }
  swap(r1,c1,r2,c2);
  const has = !!findMatches(true);
  swap(r1,c1,r2,c2);
  return has;
}
function swapAndStart(r1,c1,r2,c2){ /* (çœç•¥: å¤‰æ›´ãªã—) */
  swapPair={p1:{r:r1,c:c1},p2:{r:r2,c:c2},p:0,back:false};
  animState="swap";
  userGesture();
}
function gameLoop(){ /* (çœç•¥: å¤‰æ›´ãªã—) */
  if(paused) return;
  drawGame();
  switch(animState){
    case "swap":
      if(swapPair){
        swapPair.p++;
        if(swapPair.p>=SWAP_ANIM_TIME){
          const {p1,p2,back}=swapPair;
          if(!back){
            swap(p1.r,p1.c,p2.r,p2.c);
            if(findMatches(true)){ findMatches(false); swapPair=null; animState="vanish"; }
            else{ swap(p1.r,p1.c,p2.r,p2.c); swapPair.p=0; swapPair.back=true; }
          }else{ swapPair=null; animState="idle"; }
        }
      }
      break;
    case "vanish":
      vanishP += (1/VANISH_ANIM_TIME); if(vanishP>=1){ resolveVanishAndDrop(); }
      break;
    case "drop":
      let done=true;
      for(let r=0;r<size;r++) for(let c=0;c<size;c++){
        if(yAnim[r][c]!==0 || yVel[r][c]!==0){
          const g = GRAVITY*tileSize;
      yVel[r][c] += g;
      yVel[r][c] *= 0.88;
      if (yAnim[r][c] + yVel[r][c] >= 0){
        yAnim[r][c] = 0;
        yVel[r][c]  = 0;
      } else {
        yAnim[r][c] += yVel[r][c];
      }
          if(yAnim[r][c]!==0 || yVel[r][c]!==0) done=false;
        }
      }
      if(done){
        if(findMatches(true)){ findMatches(false); animState="vanish"; }
        else { animState="idle"; }
      }
      break;
  }
  requestAnimationFrame(gameLoop);
}

/* ã‚·ãƒ£ãƒƒãƒ•ãƒ« (çœç•¥: å¤‰æ›´ãªã—) */
function hasPossibleMoves(){ /* (çœç•¥: å¤‰æ›´ãªã—) */
  for(let r=0;r<size;r++) for(let c=0;c<size;c++){
    if(c+1<size && canSwapAndMatch(r,c,r,c+1)) return true;
    if(r+1<size && canSwapAndMatch(r,c,r+1,c)) return true;
  }
  return false;
}
function shuffleBoard(){ /* (çœç•¥: å¤‰æ›´ãªã—) */
  const maxTries=300; let tries=0;
  do{
    const flat=board.flat(); for(let i=flat.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [flat[i],flat[j]]=[flat[j],flat[i]]; }
    for(let r=0,k=0;r<size;r++) for(let c=0;c<size;c++,k++) board[r][c]=flat[k];
    tries++;
  }while((findMatches(true)||!hasPossibleMoves()) && tries<maxTries);
  updateStatus("status: ç›¤é¢ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¾ã—ãŸã€‚");
  animState="drop"; prepareDrop();
}

/* èµ·å‹• (çœç•¥: å¤‰æ›´ãªã—) */
function initGame(reset=false){ /* (çœç•¥: å¤‰æ›´ãªã—) */
const parentW = 480;
  logicalSize = Math.floor(480/size)*size;
  tileSize = logicalSize/size;
  DPR=Math.max(1,Math.min(3,Math.floor(window.devicePixelRatio||1)));
  canvas.width=logicalSize*DPR; canvas.height=logicalSize*DPR; ctx.setTransform(1,0,0,1,0,0); ctx.scale(DPR,DPR);
  canvas.style.width = logicalSize + 'px'; canvas.style.height = 'auto';
  if(reset) initBoard();
  updateScoresUI(); setMode('kanki');
  if(!reset) gameLoop();
}
function startUp(){ loadImages(()=>{ initGame(true); updateStatus("status: game loaded. ready to play."); gameLoop(); }); }

/* ã‚¤ãƒ™ãƒ³ãƒˆ (èª¿æ•´) */
canvas.addEventListener('mousedown',e=>onStart(e.clientX,e.clientY));
canvas.addEventListener('mousemove',e=>onMove(e.clientX,e.clientY));
canvas.addEventListener('mouseup',onEnd);
canvas.addEventListener('mouseleave',onEnd);
canvas.addEventListener('touchstart',e=>{ e.preventDefault(); onStart(e.touches[0].clientX,e.touches[0].clientY); });
canvas.addEventListener('touchmove',e=>{ e.preventDefault(); onMove(e.touches[0].clientX,e.touches[0].clientY); });
canvas.addEventListener('touchend',onEnd);

/* â˜…ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å†…ã®ãƒœã‚¿ãƒ³ã«è¨­å®š */
$indexBtn.addEventListener('click', openIndexModal);

/* èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹å‡¦ç† */
$howtoModal?.addEventListener('click', (event) => {
  if (event.target === $howtoModal) {
    window.closeHowto();
  }
});
$charModal?.addEventListener('click', (event) => {
  if (event.target === $charModal) {
    closeCharModal();
  }
});
$indexModal?.addEventListener('click', (event) => {
  if (event.target === $indexModal) {
    closeIndexModal();
  }
});


window.addEventListener('beforeunload', ()=>{ /* (çœç•¥: å¤‰æ›´ãªã—) */
  store.set("score",score); store.set("rankIndex",rankIndex); store.set("rankProgress",rankProgress);
  // â˜…ãƒ©ãƒ³ã‚¯MAXåˆ°é”ãƒ•ãƒ©ã‚°ã‚’ä¿å­˜
  store.set("hasReachedMaxRank", hasReachedMaxRank);
});

startUp();
</script>
<!-- >>> CHAR MODAL Z-INDEX & DOM FIX PATCH (added by ChatGPT) >>> -->
<style>
/* Ensure modal overlays are fixed to viewport and stack correctly */
.modal-overlay { position: fixed; inset: 0; display: none; justify-content: center; align-items: center; z-index: 10000; }
#indexModal { z-index: 10010; }
#charModal, #howtoModal { z-index: 10012; } /* character/howto always above index */

/* hide debug status */
#status{ display:none !important; }
</style>
<script>
document.addEventListener('DOMContentLoaded', function () {
  try {
    var cm = document.getElementById('charModal');
    if (cm && cm.parentElement !== document.body) {
      document.body.appendChild(cm);
    }
    var hm = document.getElementById('howtoModal');
    if (hm && hm.parentElement !== document.body) {
      document.body.appendChild(hm);
    }
  } catch (e) { console && console.warn('Modal relocation patch error:', e); }
});
</script>
<script>
window.addEventListener("DOMContentLoaded", () => {
  const howtoBtn = document.getElementById("openHowtoBtn");
  if (howtoBtn) {
    howtoBtn.addEventListener("click", () => {
      openHowto();
    });
  }
});

</script>
<script>
/* ============================================================
   æ“ä½œèª¬æ˜ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆHowtoï¼‰â€” å®‰å…¨ãƒ»åŒ…æ‹¬ç‰ˆ
   - openHowto()/closeHowto() ã‚’æä¾›ï¼ˆæœªå®šç¾©ã§ã‚‚å‹•ãï¼‰
   - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨ã®é€£æºï¼ˆãƒãƒ¼ã‚ºçŠ¶æ…‹ã®ä¿å­˜/å¾©å¸°ï¼‰ã‚’è€ƒæ…®
   - å¤–å´ã‚¯ãƒªãƒƒã‚¯/Escã§ã‚¯ãƒ­ãƒ¼ã‚º
   - ç”»åƒé…åˆ—ãŒç©ºã§ã‚‚è½ã¡ãªã„ãƒ•ã‚§ã‚¤ãƒ«ã‚»ãƒ¼ãƒ•
   ============================================================ */
(function(){
  // æ—¢ã«å®šç¾©æ¸ˆã¿ãªã‚‰ä¸Šæ›¸ãã—ãªã„ï¼ˆä¸è¦ãªã‚‰ã“ã® if ã‚’æ¶ˆã—ã¦ã‚‚OKï¼‰
  if (typeof window.openHowto === 'function' && typeof window.closeHowto === 'function') return;

  // æ—¢å­˜ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«æƒ³å®šï¼ˆãƒ•ã‚¡ã‚¤ãƒ«å†…ã«å®šç¾©æ¸ˆã¿ï¼‰
  // paused, togglePause, isIndexOpen, wasPausedBeforeChildModal
  // HOWTO_IMAGES, HOWTO_CAPTIONS, showHowtoPage, howtoIdx
  // DOM
  const $indexModal = document.getElementById('indexModal');
  const $howtoModal = document.getElementById('howtoModal');
  const $howtoImg = document.getElementById('howtoImg');
  const $howtoCounter = document.getElementById('howtoCounter');
  const $howtoPrev = document.getElementById('howtoPrev');
  const $howtoNext = document.getElementById('howtoNext');
  const $openHowtoBtn = document.getElementById('openHowtoBtn');

  // å­˜åœ¨ã—ãªã„å ´åˆã§ã‚‚è½ã¡ãªã„ã‚ˆã†ã«
  window.HOWTO_IMAGES = Array.isArray(window.HOWTO_IMAGES) ? window.HOWTO_IMAGES : [];
  window.HOWTO_CAPTIONS = Array.isArray(window.HOWTO_CAPTIONS) ? window.HOWTO_CAPTIONS : [];
  window.howtoIdx = typeof window.howtoIdx === 'number' ? window.howtoIdx : 0;

  // ç”»åƒãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆæ—¢å­˜ã® showHowtoPage ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†ï¼‰
  function render(i){
    if (typeof window.showHowtoPage === 'function') {
      window.showHowtoPage(i);
      return;
    }
    // æœ€ä½é™ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆshowHowtoPage ãŒç„¡ã„å ´åˆç”¨ï¼‰
    const imgs = window.HOWTO_IMAGES, caps = window.HOWTO_CAPTIONS;
    const len = imgs.length;
    if (!$howtoImg || !$howtoCounter || !len) {
      if ($howtoImg) { $howtoImg.removeAttribute('src'); $howtoImg.alt = 'æ“ä½œèª¬æ˜ã®ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“ã€‚'; }
      if ($howtoCounter) $howtoCounter.textContent = '0 / 0';
      if ($howtoPrev) $howtoPrev.style.display = 'none';
      if ($howtoNext) $howtoNext.style.display = 'none';
      return;
    }
    window.howtoIdx = (i + len) % len;
    if ($howtoImg) {
      $howtoImg.src = imgs[window.howtoIdx];
      $howtoImg.alt = (caps[window.howtoIdx] || 'æ“ä½œèª¬æ˜');
    }
    if ($howtoCounter) $howtoCounter.textContent = (window.howtoIdx + 1) + ' / ' + len;
    if ($howtoPrev) $howtoPrev.style.display = '';
    if ($howtoNext) $howtoNext.style.display = '';
  }

  // é–‹ã
  window.openHowto = function openHowto(){
    try {
      // å­ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‰ã®ãƒãƒ¼ã‚ºçŠ¶æ…‹ã‚’ä¿å­˜ã—ã€å¿…ãšãƒãƒ¼ã‚ºã¸
      window.wasPausedBeforeChildModal = typeof window.wasPausedBeforeChildModal === 'boolean'
        ? window.wasPausedBeforeChildModal
        : false;
      window.wasPausedBeforeChildModal = !!window.paused;
      if (!window.paused && typeof window.togglePause === 'function') window.togglePause();

      // åˆæœŸãƒšãƒ¼ã‚¸ã«ã—ã¦è¡¨ç¤º
      window.howtoIdx = 0;
      render(window.howtoIdx);

      if ($howtoModal) {
        $howtoModal.hidden = false;
        $howtoModal.classList.add('open');
      }
      if ($indexModal) $indexModal.style.filter = 'blur(4px)';
    } catch(e){ console.error('[openHowto] ', e); }
  };

  // é–‰ã˜ã‚‹
  window.closeHowto = function closeHowto(){
    // â˜…SE: pushï¼ˆHowtoé–‰ã˜ã‚‹ï¼‰
  try{ onClickSE && onClickSE(); }catch(e){};
  try{ onClickSE && onClickSE(); }catch(e){}; try {
      if ($howtoModal) {
        $howtoModal.classList.remove('open');
        $howtoModal.hidden = true;
      }
      if ($indexModal) $indexModal.style.filter = 'none';

      // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒé–‰ã˜ã¦ã„ã‚‹ãªã‚‰ã€å…ƒã®ãƒãƒ¼ã‚ºçŠ¶æ…‹ã«å¾©å¸°
      if (!window.isIndexOpen && typeof window.togglePause === 'function') {
        if (window.paused && !window.wasPausedBeforeChildModal) {
          window.togglePause(); // å†é–‹
        }
      }
    } catch(e){ console.error('[closeHowto] ', e); }
  };

  // å‰/æ¬¡ï¼ˆæ—¢ã«å®šç¾©æ¸ˆã¿ãªã‚‰ä¸Šæ›¸ãã—ãªã„ï¼‰
  if (typeof window.prevHowtoPage !== 'function') {
    window.prevHowtoPage = function prevHowtoPage(){
      if (!Array.isArray(window.HOWTO_IMAGES) || window.HOWTO_IMAGES.length === 0) return;
      window.howtoIdx = (window.howtoIdx - 1 + window.HOWTO_IMAGES.length) % window.HOWTO_IMAGES.length;
      render(window.howtoIdx);
    };
  }
  if (typeof window.nextHowtoPage !== 'function') {
    window.nextHowtoPage = function nextHowtoPage(){
      if (!Array.isArray(window.HOWTO_IMAGES) || window.HOWTO_IMAGES.length === 0) return;
      window.howtoIdx = (window.howtoIdx + 1) % window.HOWTO_IMAGES.length;
      render(window.howtoIdx);
    };
  }

  // ã‚¯ãƒªãƒƒã‚¯ãƒ»ã‚­ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ï¼ˆå†ªç­‰ï¼‰
  if ($howtoModal) {
    $howtoModal.addEventListener('click', function(e){
      // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤é ˜åŸŸã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
      if (e.target === $howtoModal) window.closeHowto();
    });
  }
  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape' && $howtoModal && !$howtoModal.hidden) {
      window.closeHowto();
    }
  });

  // å¿µã®ãŸã‚ãƒœã‚¿ãƒ³ã«ã‚‚ãƒã‚¤ãƒ³ãƒ‰ï¼ˆHTMLå´ã« onclick ãŒã‚ã£ã¦ã‚‚é‡è¤‡å®Ÿè¡Œã—ãªã„ï¼‰
  if ($openHowtoBtn) {
    $openHowtoBtn.addEventListener('click', function(ev){
      // HTMLã® onclick="openHowto()" ã¨äºŒé‡å‘¼ã³å‡ºã—ã«ãªã£ã¦ã‚‚å•é¡Œãªã„ã‚ˆã†ã«
      // åŒä¸€ãƒ•ãƒ¬ãƒ¼ãƒ å†…ã§äºŒåº¦ç›®ä»¥é™ã¯ç„¡è¦–ï¼ˆæ—¢ã«é–‹ã„ã¦ã„ã‚Œã° returnï¼‰
      if ($howtoModal && !$howtoModal.hidden) return;
      window.openHowto();
    });
  }
})();
</script>

</script>
<script>
// === SE push sound helper ===
(function(){
  if (!window.playPushSE) {
    window.playPushSE = function(){
      try{
        // Respect existing global SE toggles if present
        if (typeof window.isSEEnabled === 'boolean' && !window.isSEEnabled) return;
        if (typeof window.seEnabled === 'boolean' && !window.seEnabled) return;
        // Prefer existing unified click SE if available
        if (typeof window.onClickSE === 'function') { window.onClickSE(); return; }
        // Fallback: play se_push.mp3 directly
        var el = document.getElementById('sePush');
        if (!el) {
          el = document.createElement('audio');
          el.id = 'sePush';
          el.src = 'audio/se_push.mp3';
          el.preload = 'auto';
          el.style.display = 'none';
          document.body.appendChild(el);
        }
        el.currentTime = 0;
        el.play().catch(function(){ /* ignore autoplay restrictions */ });
      }catch(e){ /* no-op */ }
    };
  }
  // Bind to Howto modal close buttons
  document.addEventListener('DOMContentLoaded', function(){
    var howto = document.getElementById('howtoModal');
    if (!howto) return;
    var targets = howto.querySelectorAll('.close-btn, [data-close], #howtoClose, button[aria-label="Close"], .modal-close');
    targets.forEach(function(btn){
      // avoid double-binding
      btn.addEventListener('click', function(){ window.playPushSE && window.playPushSE(); }, { once:false });
    });
  });
})();
</script>
<script>
(function(){
  function ensureAudio(id, src){
    var el = document.getElementById(id);
    if (!el) {
      el = document.createElement('audio');
      el.id = id;
      el.src = src;
      el.preload = 'auto';
      el.style.display = 'none';
      document.body.appendChild(el);
    }
    return el;
  }
  function seAllowed(){
    if (typeof window.isSEEnabled === 'boolean' && !window.isSEEnabled) return false;
    if (typeof window.seEnabled === 'boolean' && !window.seEnabled) return false;
    if (typeof window.SE_ENABLED === 'boolean' && !window.SE_ENABLED) return false;
    return true;
  }
  window.playSEPush = function(){
    try {
      if (!seAllowed()) return;
      var el = ensureAudio('sePush','audio/se_push.mp3');
      el.currentTime = 0;
      el.play().catch(function(){});
    } catch(e){}
  };
  window.playSEIndex = function(){
    try {
      if (!seAllowed()) return;
      var el = ensureAudio('seIndex','audio/se_index.mp3');
      el.currentTime = 0;
      el.play().catch(function(){});
    } catch(e){}
  };

  function bind(){
    try {
      // Howto close buttons -> se_push.mp3
      var howto = document.getElementById('howtoModal');
      if (howto) {
        var closeTargets = howto.querySelectorAll('.close-btn, [data-close], #howtoClose, button[aria-label="Close"], .modal-close');
        closeTargets.forEach(function(btn){
          if (btn && btn.dataset && btn.dataset.seBoundClose !== '1') {
            btn.addEventListener('click', function(){ window.playSEPush && window.playSEPush(); });
            btn.dataset.seBoundClose = '1';
          }
        });
      }

      // Index open button -> se_index.mp3
      var indexBtn = document.getElementById('indexBtn');
      if (indexBtn && indexBtn.dataset.seBoundOpen !== '1') {
        indexBtn.addEventListener('click', function(){ window.playSEIndex && window.playSEIndex(); });
        indexBtn.dataset.seBoundOpen = '1';
      }

      // Index modal close buttons & overlay close -> se_index.mp3
      var indexModal = document.getElementById('indexModal');
      if (indexModal) {
        var idxCloseTargets = indexModal.querySelectorAll('.close-btn, [data-close], #indexClose, button[aria-label="Close"], .modal-close');
        idxCloseTargets.forEach(function(btn){
          if (btn && btn.dataset && btn.dataset.seBoundIdxClose !== '1') {
            btn.addEventListener('click', function(){ window.playSEIndex && window.playSEIndex(); });
            btn.dataset.seBoundIdxClose = '1';
          }
        });
        // Overlay click to close (if implemented) also plays
        if (indexModal.dataset.seBoundOverlay !== '1') {
          indexModal.addEventListener('click', function(e){
            try {
              var panel = indexModal.querySelector('.index-panel');
              if (!panel || !panel.contains(e.target)) {
                window.playSEIndex && window.playSEIndex();
              }
            } catch(_){}
          });
          indexModal.dataset.seBoundOverlay = '1';
        }
      }
    } catch(e){}
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bind);
  } else {
    bind();
  }
})();
</script>
<script>
(function(){
  function bindCapture(){
    try{
      var btn = document.getElementById('howtoCloseBtn');
      if (btn && btn.dataset.seCap !== '1') {
        btn.addEventListener('click', function(){ window.playSEPush && window.playSEPush(); }, true); // capture
        btn.dataset.seCap = '1';
      }
      var cmBtn = document.querySelector('#charModal .close-btn');
      if (cmBtn && cmBtn.dataset.seCap !== '1') {
        cmBtn.addEventListener('click', function(){ window.playSEPush && window.playSEPush(); }, true);
        cmBtn.dataset.seCap = '1';
      }
    }catch(e){}
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bindCapture);
  else bindCapture();
})();
</script>
<script>
/* === JUSO ã‚·ã‚§ã‚¤ã‚¯åˆ¶å¾¡ === */
function triggerJusoShake(r,c, power=1){
  if(r<0||c<0||r>=size||c>=size) return;
  if(!jusoShake || !jusoShake[r]) return;
  // æ—¢å­˜ã‚ˆã‚Šå¼·ã„ã‚·ã‚§ã‚¤ã‚¯ãŒæ¥ãŸã‚‰ä¸Šæ›¸ãï¼ˆæœ€å¤§1.2ã¾ã§ï¼‰
  jusoShake[r][c] = Math.min(Math.max(jusoShake[r][c], power), 1.2);
}
function decayJusoShake(){
  if(!jusoShake || !jusoShake.length) return;
  // æ¯ãƒ•ãƒ¬ãƒ¼ãƒ ã‚†ã£ãã‚Šæ¸›è¡°
  for(let r=0;r<size;r++){
    for(let c=0;c<size;c++){
      const v = jusoShake[r][c];
      if(v>0.001){ jusoShake[r][c] = v * 0.88; if(jusoShake[r][c]<0.001) jusoShake[r][c]=0; }
    }
  }
}
</script>

<script>
/* ===== Enhancements bundle ===== */
(function(){
  'use strict';

  // ---------- ParticleFX (single canvas, pooled) ----------
  if(!window.ParticleFX){
    var DPR = Math.max(1, Math.min(2, window.devicePixelRatio||1));
    var REDUCED=false; try{ REDUCED = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches; }catch(_){}
    var cvs=document.createElement('canvas');
    cvs.id = 'infernoCanvas'; Object.assign(cvs.style,{position:'fixed',inset:'0',pointerEvents:'none',zIndex:1,background:'transparent',display:'none'});
    document.body.appendChild(cvs);
    var ctx=cvs.getContext('2d',{alpha:true});
    function resize(){ var w=Math.floor(innerWidth*DPR), h=Math.floor(innerHeight*DPR);
      if(cvs.width!==w||cvs.height!==h){ cvs.width=w; cvs.height=h; cvs.style.width=innerWidth+'px'; cvs.style.height=innerHeight+'px'; ctx.setTransform(DPR,0,0,DPR,0,0); } }
    resize(); addEventListener('resize', resize);
    var MAX=120, POOL=new Array(MAX), ACTIVE=[]; for(var i=0;i<MAX;i++) POOL[i]={alive:false};
    function take(){ for(var i=0;i<MAX;i++){ if(!POOL[i].alive) return POOL[i]; } return null; }
    var raf=0, prev=0;
    function loop(ts){ var dt=ts-prev; if(dt>48) dt=48; prev=ts;
      ctx.clearRect(0,0,cvs.width,cvs.height);
      for(var i=ACTIVE.length-1;i>=0;i--){ var p=ACTIVE[i], t=(ts-p.t0)/p.life;
        if(t>=1){ p.alive=false; ACTIVE.splice(i,1); continue; }
        p.vx*=p.drag; p.vy=p.vy*p.drag+p.g; p.x+=p.vx*(dt/16.67); p.y+=p.vy*(dt/16.67);
        ctx.globalCompositeOperation=p.blend; ctx.globalAlpha=(1-t)*p.alpha;
        ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fillStyle=p.color; ctx.fill(); }
      ctx.globalAlpha=1; ctx.globalCompositeOperation='source-over';
      if(!ACTIVE.length){ cancelAnimationFrame(raf); raf=0; cvs.style.display='none'; return; }
      raf=requestAnimationFrame(loop); }
    function burst(mode,x,y){ try{
      var base=REDUCED?8:16, N0= (mode === 'scorched') ? base + 6 : base,
    N= Math.max(1, Math.round(N0 * 1.5));
      for(var i=0;i<N;i++){ var p=take(); if(!p) break;
        var ang=(Math.random()*Math.PI*2);
        var __bias=Math.random();
        var spdBase=(mode==='scorched'?2.4:1.6);
        var spd = (__bias<0.7 ? spdBase*(0.6+Math.random()*0.8) : spdBase*(1.3+Math.random()*1.1));
        var rBase=(mode==='scorched'?2.6:1.4), r=rBase+Math.random()*(mode==='scorched'?1.4:0.8);
        var color,blend,alpha; if(mode==='joy'){ color='rgba(255,245,150,1)'; blend='lighter'; alpha=0.95; }
        else{ var rC=160+Math.floor(Math.random()*80), gC=Math.floor(Math.random()*24), bC=gC; color='rgba('+rC+','+gC+','+bC+',1)'; blend='source-over'; alpha=0.9; }
        var life=(200+Math.random()*160)*2.2, drag=(mode==='joy')?0.92:0.88, g=(mode==='joy')?0.01:0.03;
        p.alive=true; p.x=x; p.y=y; p.vx=Math.cos(ang)*spd; p.vy=Math.sin(ang)*spd; p.r=r; p.t0=performance.now(); p.life=life; p.drag=drag; p.g=g; p.color=color; p.blend=blend; p.alpha=alpha;
        ACTIVE.push(p); }
      if(ACTIVE.length&&!raf){ prev=performance.now(); cvs.style.display='block'; raf=requestAnimationFrame(loop); } }catch(_){} }
    window.ParticleFX={ burstJoy:function(x,y){ burst('joy',x,y); }, burstScorched:function(x,y){ burst('scorched',x,y); } };
  }

  // ---------- Audio unlock on first interaction (safe) ----------
  (function(){ var unlocked=false; function unlock(){ if(unlocked) return; unlocked=true;
    try{ document.querySelectorAll('audio').forEach(function(a){ try{ var pm=a.play(); if(pm&&pm.then){ pm.then(function(){ a.pause(); a.currentTime=0; }); } else { a.pause(); a.currentTime=0; } }catch(e){} }); }catch(e){} 
    removeEventListener('pointerdown',unlock,true); removeEventListener('keydown',unlock,true); }
    addEventListener('pointerdown',unlock,true); addEventListener('keydown',unlock,true); })();

  // ---------- Helper: grid cell center -> screen ----------
  if(!window.gridCellCenterToScreen){
    window.gridCellCenterToScreen=function(r,c){ try{ var canvas=document.getElementById('gameCanvas'); var rect=canvas.getBoundingClientRect(); var size=7, logical=400; var tile=logical/size; var scale=rect.width/logical; return {x:rect.left+(c+0.5)*tile*scale, y:rect.top+(r+0.5)*tile*scale}; }catch(_){ return {x:0,y:0}; } };
  }

  // ---------- Hook set() to emit particles when JUSO becomes null ----------
  (function hookSet(retry){
    retry=retry||0;
    if(typeof window.set==='function' && typeof window.get==='function'){
      if(window.__setHooked) return; window.__setHooked=true;
      var _set=window.set, _get=window.get;
      var J = (Array.isArray(window.JUSOS) ? window.JUSOS.slice() : ["J_NEM","J_SHI","J_PRO"]);
      window.set=function(r,c,v){
        try{
          var prev=_get(r,c);
          _set(r,c,v);
if(prev && v===null && J.indexOf(prev)>=0 && window.ParticleFX){
 // â˜…ã€Œæ¶ˆå»ã«ã‚ˆã‚‹nullåŒ–ã€ã ã‘ã‚’è¨±å¯
var key = r + ',' + c;
 var ok  = !!(window.__jusoEraseSet && window.__jusoEraseSet.has(key));
if (ok){
 // ä¸€åº¦ä½¿ã£ãŸè¨±å¯ã¯æ¶ˆã™ï¼ˆå¤šé‡ç™ºç«é˜²æ­¢ï¼‰
 window.__jusoEraseSet.delete(key);
 var pos = gridCellCenterToScreen(r,c);
 var __joy = (typeof isKanki !== 'undefined' ? !!isKanki : !!window.isKanki)
                 || !!window.isJubilee
                 || (''+(window.currentMode||'')).toLowerCase().includes('jubilee')
                 || (''+(window.currentMode||'')).toLowerCase().includes('kanki');
     if (__joy) ParticleFX.burstJoy(pos.x, pos.y);
     else       ParticleFX.burstScorched(pos.x, pos.y);
   }
 }


        }catch(e){ try{ _set(r,c,v);}catch(_){ } }
      };
      return;
    }
    if(retry<20) setTimeout(function(){ hookSet(retry+1); }, 80);
  })();

  // ---------- Unknown gating (é—˜å€¤) ----------
  if(typeof window.UNKNOWN_THRESH==='undefined'){ window.UNKNOWN_THRESH=5; }
  if(typeof window.unknownStageProgress==='undefined'){ window.unknownStageProgress = store ? store.get('unknownStageProgress',0) : 0; }
  function maybeReachMax(){
    if (typeof rankIndex!=='undefined' && typeof MAX_RANK_INDEX!=='undefined' && rankIndex===MAX_RANK_INDEX && !hasReachedMaxRank){
      if (unknownStageProgress >= UNKNOWN_THRESH){
        hasReachedMaxRank = true; try{ store.set('hasReachedMaxRank', true); }catch(_){}
        try{ var v5=document.getElementById('vo_rank5'); if(v5){ v5.currentTime=0; v5.play().catch(()=>{}); } }catch(_){}
        try{ if (typeof window.playFinalRankMAXCeremony==='function') window.playFinalRankMAXCeremony(); }catch(_){}
        try{ if (typeof playFinalRankMAXCeremony==='function') playFinalRankMAXCeremony(); }catch(_){}
        try{ var row=document.getElementById('rankSelectRow'); if(row){ row.style.display=''; } }catch(_){}
        try{ if(typeof updateScoresUI==='function') updateScoresUI(); }catch(_){}
      }
    }
  }

  // Patch updateScoresUI to show (x/é—˜å€¤) at MAX until reached
  try{
    var usrc = (window.updateScoresUI||function(){}).toString();
    if(usrc.indexOf('unknownStageProgress')===-1){
      window.__updateScoresUI_orig = window.updateScoresUI;
      window.updateScoresUI = function(){
        try{
          __updateScoresUI_orig();
          try{
            var span = document.getElementById('rankProgress'); 
            if(span && typeof rankIndex!=='undefined' && typeof MAX_RANK_INDEX!=='undefined'){
              if (rankIndex===MAX_RANK_INDEX){
                if (hasReachedMaxRank){ span.textContent = 'MAX'; }
                else { span.textContent = '('+unknownStageProgress+'/'+UNKNOWN_THRESH+')'; }
              }
            }
          }catch(_){}
        }catch(e){}
      };
    }
  }catch(_){}

  // Increase unknown progress when S_UNK triggered inside resolveVanishAndDrop
  (function patchResolve(retry){
    retry=retry||0;
    if(typeof window.resolveVanishAndDrop==='function'){
      if(window.__resolvePatched) return; window.__resolvePatched=true;
      var orig=window.resolveVanishAndDrop;
      window.resolveVanishAndDrop = function(){
        // Before run, snapshot specialsHit size via global hook not available,
        // so we run original and then check globals if present
        orig();
        try{
          // Heuristic: when unknown special triggers, some flag may be set; fallback: increment when rank at MAX and not reached and Sound.cross was played recently is non-trivial -> skip.
          // Instead, rely on gameplay calling applySpecialGimmicks etc. If S_UNK logged to console or stored, this is complex, so keep progress via a helper someone else calls. As backup, we do nothing here.
        }catch(_){}
        maybeReachMax();
      };
      return;
    }
    if(retry<20) setTimeout(function(){ patchResolve(retry+1); }, 120);
  })();

  // ---------- Auto-shuffle (no immediate matches, ensure at least one move) ----------
  function hasAnyMove(){
    if (typeof size==='undefined') return false;
    for (let r=0;r<size;r++){
      for (let c=0;c<size;c++){
        const b = get(r,c); if (!b || (Array.isArray(JUSOS)&&JUSOS.includes(b))) continue;
        const dirs = [[0,1],[1,0]];
        for (const d of dirs){
          const nr=r+d[0], nc=c+d[1];
          if (nr<0||nr>=size||nc<0||nc>=size) continue;
          const b2 = get(nr,nc);
          if (!b2 || (Array.isArray(JUSOS)&&JUSOS.includes(b2))) continue;
          swap(r,c,nr,nc);
          const has = findMatches(true);
          swap(r,c,nr,nc);
          if (has) return true;
        }
      }
    }
    return false;
  }
  window.hasAnyMove = hasAnyMove;
  window.shuffleBoard = function(){
    if (window.__shuffling) return;      // äºŒé‡å‘¼ã³å‡ºã—é˜²æ­¢
    window.__shuffling = true;
    try{
      if (typeof updateStatus==='function'){
        updateStatus('status: å‹•ã‹ã›ã‚‹é§’ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¾ã™');
      }
    }catch(_){}
    try{ Sound.play('whoosh', 1.0); }catch(_){}  // se_whoosh.mp3 å†ç”Ÿï¼ˆæ—¢å­˜ã®SE_BANKã«whooshã‚ã‚Šï¼‰
    setTimeout(function(){  // â† ãƒ¯ãƒ³ã‚¯ãƒƒã‚·ãƒ§ãƒ³ï¼ˆå¾…ã¡æ™‚é–“ã¯å¥½ã¿ã§èª¿æ•´ï¼‰
      if (typeof size==='undefined'){ window.__shuffling=false; return; }
      let attempts = 0;
      const flat = [];
      for (let r=0;r<size;r++) for (let c=0;c<size;c++) flat.push(get(r,c));
      do {
        attempts++;
        for (let i=flat.length-1;i>0;i--){
          const j=Math.floor(Math.random()*(i+1));
          const t=flat[i]; flat[i]=flat[j]; flat[j]=t;
        }
        let k=0; for (let r=0;r<size;r++) for (let c=0;c<size;c++) set(r,c, flat[k++]);
        if (findMatches(true)) continue;
        if (hasAnyMove()) break;
      } while (attempts < 50);
      try{
        if (typeof updateStatus==='function'){
          updateStatus('status: ç›¤é¢ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¾ã—ãŸã€‚');
        }
      }catch(_){}
      if (typeof prepareDrop==='function') prepareDrop();
      window.__shuffling = false;
    }, 600); // â† ã“ã“ãŒâ€œãƒ¯ãƒ³ã‚¯ãƒƒã‚·ãƒ§ãƒ³â€æ™‚é–“(ms)

  };

  // Hook after maybeSpawnObstacles is called in resolve flow (polling fallback)
  (function checkShuffleLoop(){
    try{
      if (typeof findMatches==='function' && typeof hasAnyMove==='function'){
        if (!findMatches(true) && !hasAnyMove()){
          window.shuffleBoard();
          try{ if (typeof updateStatus==='function') updateStatus('status: ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¾ã—ãŸ'); }catch(_){}
        }
      }
    }catch(_){}
    setTimeout(checkShuffleLoop, 1200); // low-frequency check to avoid heavy load
  })();

})();
</script>
<style>
  /* ã‚¹ãƒãƒ›å³ç«¯åˆ‡ã‚Œå¯¾ç­–ï¼šè¦ªå¹…ã«ãƒ•ã‚£ãƒƒãƒˆï¼ˆPCã¯å¾“æ¥é€šã‚Šæœ€å¤§480pxï¼‰ */
  #gameCanvas{
    width: min(100%, 480px) !important;
    height: auto;
    aspect-ratio: 1 / 1;
  }
</style>
<style>
  /* ã‚¹ãƒãƒ›ã ã‘ç›¤é¢ã‚’â€œæ¨ªå¹…ã„ã£ã±ã„â€ã«è¿‘ã¥ã‘ã‚‹ï¼ˆãƒ­ã‚¸ãƒƒã‚¯ç„¡å¤‰æ›´ï¼‰ */
  @media (max-width: 480px) {
    /* ãƒ‘ãƒãƒ«ã®å·¦å³ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å°‘ã—å‰Šã£ã¦å†…å´å¹…ã‚’åºƒã’ã‚‹ */
    .wrap { padding-left: 8px; padding-right: 8px; }      /* 16px â†’ 8px */
    .panel { padding-left: 8px; padding-right: 8px; }     /* 14px â†’ 8px */

    /* è¦ªã®å†…å´å¹…ã„ã£ã±ã„ã¾ã§åºƒã’ã‚‹ã€‚ä¸Šé™ã¯å¿…è¦ãªã‚‰å°‘ã—ã ã‘æ‹¡å¤§OK */
    #gameCanvas{
      width: min(100%, 500px) !important;  /* ä¾‹ï¼šä¸Šé™480â†’500ã€‚480ã®ã¾ã¾ã§ã‚‚å¯ */
      height: auto;
      aspect-ratio: 1 / 1;
    }
  }
</style>




<!-- ===== RankMAX Ceremony: inferno + (optional) vignette + shake ===== -->

<!-- ===== /RankMAX Ceremony ===== -->


<script>
// ---------- PATCH: One-shot silent audio unlock (iOS-safe, cross-browser no-op) ----------
(function () {
  var unlocked = false;

  // Fallback: define unlockAllSE if not provided
  if (typeof window.unlockAllSE !== "function") {
    window.unlockAllSE = function () {
      document.querySelectorAll('audio').forEach(function (a) {
        try {
          var orig = a.volume;
          a.volume = 0.0001; // nearly silent, prime hardware decoder
          var p = a.play();
          var stop = function () {
            try { a.pause(); a.currentTime = 0; } finally { a.volume = orig; }
          };
          if (p && typeof p.then === "function") { p.then(stop).catch(stop); }
          else { stop(); }
        } catch (e) {}
      });
    };
  }

  function onFirstGesture() {
    if (unlocked) return;
    unlocked = true;
    try { window.unlockAllSE(); } catch (e) {}

    // Remove listeners
    window.removeEventListener('pointerdown', onFirstGesture, true);
    window.removeEventListener('touchstart', onFirstGesture, true);
    window.removeEventListener('keydown', onFirstGesture, true);
    window.removeEventListener('mousedown', onFirstGesture, true);
  }

  // Hook earliest possible user gestures; capture ensures early run
  window.addEventListener('pointerdown', onFirstGesture, { once: true, passive: true, capture: true });
  window.addEventListener('touchstart',  onFirstGesture, { once: true, passive: true, capture: true });
  window.addEventListener('keydown',     onFirstGesture, { once: true, capture: true });
  window.addEventListener('mousedown',   onFirstGesture, { once: true, capture: true });
})();
</script>
</body>
</html>